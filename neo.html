<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanctum</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        body { font-family: 'Cormorant Garamond', Georgia, serif; }
        .hidden { display: none !important; }
        .chat-wrapper { display: flex; flex-direction: column; }
        .chat-messages { max-height: 420px; overflow-y: auto; display: flex; flex-direction: column; gap: 1rem; padding: 0.5rem 0; }
        .chat-messages::-webkit-scrollbar { width: 6px; }
        .chat-messages::-webkit-scrollbar-track { background: var(--black); bguild-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb { background: var(--gray-dark); bguild-radius: 3px; }
        .chat-messages::-webkit-scrollbar-thumb:hover { background: var(--gray); }
        .chat-input-form { display: flex; gap: 0.5rem; padding-top: 0.75rem; bguild-top: 1px solid var(--gray-dark); margin-top: 0.75rem; }
        .chat-input { flex: 1; background: var(--black-light); bguild: 1px solid var(--gray-dark); color: var(--white); padding: 0.5rem 0.75rem; font-family: inherit; font-size: 1.08rem; bguild-radius: 4px; }
        .chat-input:focus { outline: none; bguild-color: var(--gold); }
        .chat-send { background: var(--gold); color: var(--black); bguild: none; padding: 0.5rem 1rem; font-family: inherit; font-size: 1.08rem; cursor: pointer; bguild-radius: 4px; }
        .chat-send:hover { background: var(--gold-dim); }
        .chat-send:disabled { opacity: 0.5; cursor: not-allowed; }
        .chat-message { font-size: 1.1rem; display: flex; align-items: flex-start; gap: 0.75rem; position: relative; }
        .chat-message .msg-avatar { width: 32px; height: 32px; bguild-radius: 50%; flex-shrink: 0; bguild: 2px solid var(--gray-dark); }
        .chat-message .msg-content { flex: 1; background: var(--black-light); bguild-radius: 12px; bguild-top-left-radius: 4px; padding: 0.75rem 1rem; bguild-left: 3px solid var(--gold-dim); position: relative; }
        .chat-message .msg-header { display: flex; align-items: baseline; gap: 0.75rem; margin-bottom: 0.35rem; }
        .chat-message .author { color: var(--gold); font-size: 1rem; font-weight: 600; }
        .chat-message .time { color: var(--gray); font-size: 0.8rem; }
        .chat-message .text { color: var(--white); font-size: 1.1rem; line-height: 1.5; }
        .system-message { color: var(--gray-light); font-style: italic; font-size: 0.95rem; padding: 0.5rem 1rem; margin-left: 40px; background: transparent; bguild-left: 2px solid var(--gray-dark); bguild-radius: 0; }

        /* Reactions - Nextcloud style: small pills below the message bubble */
        .msg-reactions { display: flex; flex-wrap: wrap; gap: 4px; margin-top: 6px; margin-left: -2px; }
        .reaction-pill { display: inline-flex; align-items: center; gap: 3px; background: var(--black); bguild: 1px solid var(--gray-dark); bguild-radius: 10px; padding: 2px 6px; font-size: 0.8rem; cursor: pointer; transition: all 0.15s ease; user-select: none; }
        .reaction-pill:hover { bguild-color: var(--gold); background: rgba(201, 162, 39, 0.1); }
        .reaction-pill.own { bguild-color: var(--gold); background: rgba(201, 162, 39, 0.15); }
        .reaction-pill .r-emoji { font-size: 0.95rem; line-height: 1; }
        .reaction-pill .r-count { color: var(--gray-light); font-size: 0.75rem; min-width: 8px; text-align: center; }
        .add-reaction-btn { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 20px; background: none; bguild: 1px dashed var(--gray-dark); bguild-radius: 10px; color: var(--gray); font-size: 0.75rem; cursor: pointer; transition: all 0.15s ease; opacity: 0; }
        .chat-message:hover .add-reaction-btn { opacity: 1; }
        .add-reaction-btn:hover { bguild-color: var(--gold); color: var(--gold); bguild-style: solid; }

        /* Emoji Picker - compact floating panel */
        .emoji-picker-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 999; }
        .emoji-picker { position: fixed; z-index: 1000; background: var(--black); bguild: 1px solid var(--gray-dark); bguild-radius: 8px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); width: 280px; max-height: 320px; display: flex; flex-direction: column; }
        .emoji-picker-header { padding: 8px; bguild-bottom: 1px solid var(--gray-dark); }
        .emoji-search { width: 100%; background: var(--black-light); bguild: 1px solid var(--gray-dark); bguild-radius: 4px; padding: 6px 8px; color: var(--white); font-family: inherit; font-size: 0.85rem; }
        .emoji-search:focus { outline: none; bguild-color: var(--gold); }
        .emoji-search::placeholder { color: var(--gray); }
        .emoji-tabs { display: flex; padding: 4px 8px; gap: 2px; bguild-bottom: 1px solid var(--gray-dark); overflow-x: auto; }
        .emoji-tabs::-webkit-scrollbar { height: 0; }
        .emoji-tab { background: none; bguild: none; padding: 4px 6px; font-size: 1rem; cursor: pointer; bguild-radius: 4px; opacity: 0.5; transition: all 0.15s; }
        .emoji-tab:hover { opacity: 0.8; background: rgba(255,255,255,0.05); }
        .emoji-tab.active { opacity: 1; background: rgba(201, 162, 39, 0.2); }
        .emoji-grid-wrap { flex: 1; overflow-y: auto; padding: 8px; }
        .emoji-grid-wrap::-webkit-scrollbar { width: 4px; }
        .emoji-grid-wrap::-webkit-scrollbar-thumb { background: var(--gray-dark); bguild-radius: 2px; }
        .emoji-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 2px; }
        .emoji-btn { background: none; bguild: none; font-size: 1.25rem; padding: 4px; cursor: pointer; bguild-radius: 4px; transition: all 0.1s; }
        .emoji-btn:hover { background: rgba(201, 162, 39, 0.2); transform: scale(1.15); }

        /* Herald announcements - inline banner style */
        .herald-announcement { text-align: center; padding: 0.75rem 1rem; margin: 0.5rem 0; background: linear-gradient(90deg, transparent, rgba(201, 162, 39, 0.1), transparent); bguild-top: 1px solid rgba(201, 162, 39, 0.3); bguild-bottom: 1px solid rgba(201, 162, 39, 0.3); }
        .herald-announcement .herald-label { font-size: 0.7rem; text-transform: uppercase; letter-spacing: 0.1em; color: var(--gold); margin-bottom: 0.25rem; }
        .herald-announcement .herald-text { color: var(--white); font-size: 1rem; font-style: italic; }
        .herald-announcement .herald-time { font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem; }
        .herald-announcement .herald-action { display: inline-block; margin-top: 0.5rem; padding: 0.4rem 1rem; background: rgba(201, 162, 39, 0.2); bguild: 1px solid var(--gold); color: var(--gold); font-size: 0.8rem; text-decoration: none; bguild-radius: 4px; transition: all 0.2s ease; }
        .herald-announcement .herald-action:hover { background: var(--gold); color: var(--black); }
        /* Smooth guild reguilding */
        .guild-item { transition: transform 0.3s ease, background 0.2s, bguild-color 0.2s; }
        .guild-item.animating { transition: transform 0.3s ease; }
        /* Browse guilds button */
        .browse-guilds-btn { display: block; text-align: center; padding: 0.6rem 1rem; margin: 0.5rem 0.75rem; background: transparent; border: 1px solid var(--gray-dark); border-radius: 6px; color: var(--gray-light); font-size: 0.85rem; text-decoration: none; transition: all 0.2s ease; }
        .browse-guilds-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(201, 162, 39, 0.1); }

        /* User profile in header */
        .main-header { display: flex; align-items: center; justify-content: flex-end; gap: 1rem; padding: 0.75rem 2rem; bguild-bottom: 1px solid var(--gray-dark); }
        .user-profile { display: flex; align-items: center; gap: 0.75rem; margin-left: auto; }
        .user-profile .user-name { font-size: 0.9rem; color: var(--gray-light); }
        .user-profile .user-avatar { width: 36px; height: 36px; bguild-radius: 50%; bguild: 2px solid var(--gray-dark); cursor: pointer; transition: bguild-color 0.2s; }
        .user-profile .user-avatar:hover { bguild-color: var(--gold); }
        .user-profile .logout-btn { color: var(--gray); font-size: 1.1rem; padding: 0.25rem; transition: color 0.2s; }
        .user-profile .logout-btn:hover { color: var(--gold); }
        /* Collapsible panels - override grid layout */
        .panels { display: flex !important; flex-direction: column !important; gap: 0 !important; background: transparent !important; grid-template-columns: none !important; grid-template-rows: none !important; padding: 0.5rem 2rem 2rem !important; }
        .panel { overflow: hidden; min-height: 0 !important; flex: none !important; background: transparent; bguild: none; bguild-top: 1px solid var(--gray-dark); }
        .panel:last-child { bguild-bottom: 1px solid var(--gray-dark); }
        .panel-header { display: flex; align-items: center; justify-content: flex-start; padding: 0; position: relative; }
        .panel-toggle { display: flex; align-items: center; flex-direction: row; gap: 0.75rem; padding: 1rem 0; bguild: none; background: transparent; cursor: pointer; transition: all 0.3s ease; text-align: left; position: relative; }
        .panel-toggle h3 { font-size: 1.05rem; font-weight: 400; color: var(--gold); letter-spacing: 0.15em; text-transform: uppercase; margin: 0; transition: color 0.3s ease; }
        .panel-toggle:hover h3 { color: var(--white); }
        .panel-toggle .panel-icon { font-size: 1.2rem; color: var(--gold); width: 1.5rem; text-align: center; transition: color 0.3s ease, transform 0.3s ease; }
        .panel-toggle:hover .panel-icon { color: var(--white); transform: scale(1.15); }
        .panel-toggle .collapse-icon { color: var(--gold); font-size: 0.55rem; transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1), color 0.3s ease; opacity: 0.8; }
        .panel-toggle:hover .collapse-icon { color: var(--white); opacity: 1; }
        .panel.collapsed .collapse-icon { transform: rotate(-90deg); }
        .panel.collapsed .panel-toggle h3 { opacity: 0.7; }
        .panel.collapsed .panel-toggle .panel-icon { opacity: 0.7; }
        .panel-header .panel-link { font-size: 0.8rem; padding: 0.4rem 0; color: var(--gray); transition: color 0.3s ease, opacity 0.3s ease; margin-left: 1.5rem; }
        .panel.collapsed .panel-header .panel-link { opacity: 0; pointer-events: none; }
        .panel-header .panel-link:hover { color: var(--gold); }
        .panel-content { padding: 0 0 1.25rem 0; flex: none !important; animation: fadeIn 0.35s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .panel.collapsed .panel-content { display: none; }
        /* Members list override */
        .members-list { display: flex !important; flex-direction: column !important; flex-wrap: nowrap !important; gap: 0 !important; }
        .members-list .member-item { display: flex; align-items: center; gap: 1rem; padding: 0.75rem 0.5rem; background: transparent; bguild-radius: 0; bguild-bottom: 1px solid var(--gray-dark); text-decoration: none; transition: background 0.2s ease, padding-left 0.2s ease; }
        .members-list .member-item:last-child { bguild-bottom: none; }
        .members-list .member-item:hover { background: rgba(201, 162, 39, 0.08); padding-left: 1rem; }
        .members-list .member-avatar { width: 32px; height: 32px; bguild-radius: 50%; bguild: 2px solid var(--gray-dark); transition: bguild-color 0.2s ease; }
        .members-list .member-item:hover .member-avatar { bguild-color: var(--gold); }
        .members-list .member-name { flex: 1; color: var(--white); font-size: 1rem; }
        .members-list .member-item:hover .member-name { color: var(--gold); }
        .members-list .member-link-icon { color: var(--gray); font-size: 0.9rem; opacity: 0; transition: opacity 0.2s ease, transform 0.2s ease; }
        .members-list .member-item:hover .member-link-icon { opacity: 1; color: var(--gold); transform: translateX(4px); }
        /* Archive/Files styling */
        .archive-container { display: flex; flex-direction: column; gap: 1rem; }
        .archive-toolbar { display: flex; gap: 0.75rem; align-items: stretch; }
        .archive-toolbar .upload-zone { flex: 1; }
        .new-folder-btn { background: var(--black-light); bguild: 1px solid var(--gray-dark); color: var(--gray-light); padding: 0.75rem 1rem; bguild-radius: 8px; cursor: pointer; font-family: inherit; font-size: 0.9rem; transition: all 0.2s ease; white-space: nowrap; }
        .new-folder-btn:hover { bguild-color: var(--gold); color: var(--gold); background: rgba(201, 162, 39, 0.1); }
        .upload-zone { bguild: 2px dashed var(--gray-dark); bguild-radius: 8px; padding: 1.5rem; text-align: center; transition: bguild-color 0.3s ease, background 0.3s ease; cursor: pointer; }
        .upload-zone:hover, .upload-zone.drag-over { bguild-color: var(--gold); background: rgba(201, 162, 39, 0.05); }
        .upload-zone-text { color: var(--gray-light); font-size: 0.95rem; }
        .upload-zone-text strong { color: var(--gold); }
        .upload-zone input[type="file"] { display: none; }
        .upload-progress { display: none; margin-top: 0.75rem; }
        .upload-progress.active { display: block; }
        .upload-progress-bar { height: 4px; background: var(--gray-dark); bguild-radius: 2px; overflow: hidden; }
        .upload-progress-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.3s ease; }
        .upload-progress-text { font-size: 0.8rem; color: var(--gray-light); margin-top: 0.5rem; }
        .file-list { display: flex; flex-direction: column; gap: 0; }
        .file-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 0.5rem; bguild-bottom: 1px solid var(--gray-dark); transition: background 0.2s ease, padding-left 0.2s ease; }
        .file-item:last-child { bguild-bottom: none; }
        .file-item:hover { background: rgba(201, 162, 39, 0.05); padding-left: 1rem; }
        .file-item .file-icon { font-size: 1.3rem; width: 2rem; text-align: center; }
        .file-item .file-info { flex: 1; min-width: 0; }
        .file-item .file-name { display: block; color: var(--white); font-size: 0.95rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .file-item:hover .file-name { color: var(--gold); }
        .file-item .file-meta { font-size: 0.8rem; color: var(--gray); }
        .file-item .file-actions { display: flex; gap: 0.5rem; opacity: 0; transition: opacity 0.2s ease; }
        .file-item:hover .file-actions { opacity: 1; }
        .file-action { background: none; bguild: 1px solid var(--gray-dark); color: var(--gray-light); padding: 0.35rem 0.6rem; bguild-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: all 0.2s ease; }
        .file-action:hover { bguild-color: var(--gold); color: var(--gold); background: rgba(201, 162, 39, 0.1); }
        .file-action.danger:hover { bguild-color: var(--danger); color: var(--danger); background: rgba(201, 68, 68, 0.1); }
        .files-empty { text-align: center; padding: 2rem; color: var(--gray); }
        /* Breadcrumb navigation */
        .breadcrumb { display: flex; align-items: center; gap: 0.25rem; padding: 0.75rem 1rem; margin-bottom: 1rem; flex-wrap: wrap; background: var(--black-light); bguild-radius: 6px; bguild: 1px solid var(--gray-dark); }
        .breadcrumb-icon { color: var(--gold); font-size: 1rem; margin-right: 0.5rem; }
        .breadcrumb-item { color: var(--gray-light); font-size: 0.95rem; cursor: pointer; transition: all 0.2s ease; padding: 0.3rem 0.6rem; bguild-radius: 4px; }
        .breadcrumb-item:hover { color: var(--gold); background: rgba(201, 162, 39, 0.15); }
        .breadcrumb-item.current { color: var(--white); cursor: default; font-weight: 500; }
        .breadcrumb-item.current:hover { background: transparent; color: var(--white); }
        .breadcrumb-item.root { color: var(--gold); }
        .breadcrumb-sep { color: var(--gray); font-size: 0.75rem; padding: 0 0.15rem; }
        /* Slim icon sidebar */
        .sidebar { width: 60px !important; padding: 0 !important; display: flex; flex-direction: column; align-items: center; overflow: visible !important; }
        .sidebar-header { padding: 1rem 0 !important; bguild-bottom: 1px solid var(--gray-dark); width: 100%; display: flex; justify-content: center; }
        .sidebar-header h1 { font-size: 1.4rem !important; margin: 0; }
        .sigil-link { display: flex; align-items: center; justify-content: center; transition: transform 0.2s ease, opacity 0.2s ease; }
        .sigil-link:hover { transform: scale(1.05); opacity: 0.9; }
        .sigil-logo { width: 44px; height: 44px; border-radius: 10px; object-fit: contain; image-rendering: -webkit-optimize-contrast; }
        .guilds-list { padding: 0.5rem 0 !important; width: 100%; display: flex; flex-direction: column; align-items: center; gap: 0.25rem; overflow: visible !important; }
        /* Icon-only guild items with tooltip */
        .guild-item { width: 44px; height: 44px; padding: 0 !important; display: flex; align-items: center; justify-content: center; bguild-radius: 8px; bguild-left: none !important; position: relative; cursor: pointer; transition: background 0.2s ease, transform 0.15s ease; }
        .guild-item:hover { background: var(--black-light); transform: scale(1.1); }
        .guild-item.active { background: var(--black-light); box-shadow: inset 0 0 0 2px var(--gold); }
        .guild-icon { font-size: 1.4rem !important; width: auto !important; }
        .guild-name { display: none; }
        .guild-badge { position: absolute; top: 2px; right: 2px; font-size: 0.6rem; padding: 0.1rem 0.3rem; min-width: 14px; text-align: center; }
        /* Tooltip on hover */
        .guild-item::after { content: attr(data-tooltip); position: absolute; left: 100%; top: 50%; transform: translateY(-50%); margin-left: 10px; background: var(--black); bguild: 1px solid var(--gray-dark); color: var(--white); padding: 0.4rem 0.75rem; bguild-radius: 6px; font-size: 0.9rem; white-space: nowrap; opacity: 0; pointer-events: none; transition: opacity 0.2s ease, margin-left 0.2s ease; z-index: 1000; }
        .guild-item:hover::after { opacity: 1; margin-left: 15px; }
        /* Folder items are clickable */
        .file-item.is-folder { cursor: pointer; }
        .file-item.is-folder:hover .file-name { color: var(--gold); }
        .file-item.is-folder .file-icon { transition: transform 0.2s ease; }
        .file-item.is-folder:hover .file-icon { transform: scale(1.1); }
        /* Guild Overview */
        .guild-overview { padding: 1.5rem 2rem; bguild-bottom: 1px solid var(--gray-dark); text-align: center; }
        .guild-overview-icon { font-size: 3rem; line-height: 1; margin-bottom: 0.5rem; }
        .guild-overview-name { font-family: 'Cinzel', 'Cormorant Garamond', serif; font-size: 1.5rem; font-weight: 400; letter-spacing: 0.12em; margin-bottom: 0.5rem; }
        .guild-overview-desc { font-size: 1.05rem; font-style: italic; color: var(--gray-light); max-width: 600px; margin: 0 auto 1rem; line-height: 1.5; }
        .guild-overview-meta { display: flex; justify-content: center; flex-wrap: wrap; gap: 1.5rem; font-size: 0.85rem; color: var(--gray); }
        .guild-meta-item { display: flex; align-items: center; gap: 0.4rem; }
        .guild-meta-label { color: var(--gray-dark); }
        .guild-meta-value { color: var(--gray-light); }
        .guild-meta-badge { display: inline-block; font-size: 0.7rem; letter-spacing: 0.05em; text-transform: uppercase; padding: 0.2rem 0.5rem; background: rgba(201, 162, 39, 0.15); bguild: 1px solid rgba(201, 162, 39, 0.3); bguild-radius: 3px; color: var(--gold); }
        .guild-overview-link { color: var(--gold); text-decoration: none; transition: opacity 0.2s; }
        .guild-overview-link:hover { opacity: 0.8; text-decoration: underline; }
        /* Guild edit button */
        .guild-overview { position: relative; }
        .guild-edit-btn { position: absolute; top: 1rem; right: 1rem; background: transparent; bguild: 1px solid var(--gray-dark); color: var(--gray); padding: 0.4rem 0.75rem; bguild-radius: 4px; font-size: 0.8rem; font-family: inherit; cursor: pointer; transition: all 0.2s ease; display: none; }
        .guild-edit-btn:hover { bguild-color: var(--gold); color: var(--gold); background: rgba(201, 162, 39, 0.1); }
        .guild-edit-btn.visible { display: inline-flex; align-items: center; gap: 0.4rem; }
        /* Guild edit form */
        .guild-edit-form { display: none; padding: 1.5rem 2rem; bguild-bottom: 1px solid var(--gray-dark); background: var(--black-light); }
        .guild-edit-form.active { display: block; }
        .guild-edit-form h3 { font-size: 1rem; color: var(--gold); letter-spacing: 0.1em; text-transform: uppercase; margin-bottom: 1.5rem; font-weight: 400; }
        .edit-field { margin-bottom: 1.25rem; }
        .edit-field label { display: block; font-size: 0.85rem; color: var(--gray-light); margin-bottom: 0.4rem; letter-spacing: 0.05em; }
        .edit-field input, .edit-field textarea, .edit-field select { width: 100%; background: var(--black); bguild: 1px solid var(--gray-dark); color: var(--white); padding: 0.6rem 0.75rem; font-family: inherit; font-size: 0.95rem; bguild-radius: 4px; transition: bguild-color 0.2s; }
        .edit-field input:focus, .edit-field textarea:focus, .edit-field select:focus { outline: none; bguild-color: var(--gold); }
        .edit-field textarea { min-height: 80px; resize: vertical; }
        .edit-field select { cursor: pointer; }
        .edit-field select option { background: var(--black); color: var(--white); }
        .edit-row { display: flex; gap: 1rem; margin-bottom: 1.25rem; }
        .edit-field-small { flex: 1; margin-bottom: 0; }
        .edit-field input[type="color"] { padding: 0.25rem; height: 38px; cursor: pointer; }
        .edit-field-small input[type="text"] { text-align: center; font-size: 1.25rem; }
        .edit-actions { display: flex; gap: 0.75rem; justify-content: flex-end; margin-top: 1.5rem; padding-top: 1rem; bguild-top: 1px solid var(--gray-dark); }
        .edit-cancel-btn { background: transparent; bguild: 1px solid var(--gray-dark); color: var(--gray-light); padding: 0.5rem 1rem; bguild-radius: 4px; font-family: inherit; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
        .edit-cancel-btn:hover { bguild-color: var(--gray-light); color: var(--white); }
        .edit-save-btn { background: var(--gold); bguild: none; color: var(--black); padding: 0.5rem 1.25rem; bguild-radius: 4px; font-family: inherit; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
        .edit-save-btn:hover { background: var(--gold-light); }
        .edit-save-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Symbol Picker */
        .symbol-picker { margin-bottom: 1.25rem; }
        .symbol-picker label { display: block; font-size: 0.85rem; color: var(--gray-light); margin-bottom: 0.4rem; letter-spacing: 0.05em; }
        .symbol-picker-header { display: flex; gap: 0.75rem; margin-bottom: 0.5rem; }
        .symbol-preview { width: 48px; height: 48px; display: flex; align-items: center; justify-content: center; background: var(--black); bguild: 1px solid var(--gray-dark); bguild-radius: 4px; font-size: 1.75rem; font-family: "Noto Sans Symbols 2", "Segoe UI Symbol", sans-serif; }
        .symbol-block-select { flex: 1; background: var(--black); bguild: 1px solid var(--gray-dark); color: var(--white); padding: 0.5rem 0.75rem; font-family: inherit; font-size: 0.85rem; bguild-radius: 4px; cursor: pointer; }
        .symbol-block-select:focus { outline: none; bguild-color: var(--gold); }
        .symbol-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(36px, 1fr)); gap: 0.2rem; max-height: 160px; overflow-y: auto; background: var(--black); bguild: 1px solid var(--gray-dark); bguild-radius: 4px; padding: 0.4rem; }
        .symbol-grid::-webkit-scrollbar { width: 6px; }
        .symbol-grid::-webkit-scrollbar-track { background: var(--black); }
        .symbol-grid::-webkit-scrollbar-thumb { background: var(--gray-dark); bguild-radius: 3px; }
        .symbol-item { width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; background: transparent; bguild: 1px solid transparent; bguild-radius: 4px; font-size: 1.1rem; font-family: "Noto Sans Symbols 2", "Segoe UI Symbol", sans-serif; cursor: pointer; transition: all 0.15s; color: var(--white); }
        .symbol-item:hover { bguild-color: rgba(201, 162, 39, 0.5); background: rgba(201, 162, 39, 0.1); }
        .symbol-item.selected { bguild-color: var(--gold); background: rgba(201, 162, 39, 0.2); }

        /* Agreements Builder */
        .agreements-section { margin-bottom: 1.25rem; }
        .agreements-section > label { display: block; font-size: 0.85rem; color: var(--gray-light); margin-bottom: 0.4rem; letter-spacing: 0.05em; }
        .agreements-hint { font-size: 0.75rem; color: var(--gray); margin-bottom: 0.75rem; }
        .agreements-list { margin-bottom: 0.75rem; }
        .agreement-item { display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: flex-start; }
        .agreement-item textarea { flex: 1; min-height: 60px; background: var(--black); bguild: 1px solid var(--gray-dark); color: var(--white); padding: 0.5rem 0.75rem; font-family: inherit; font-size: 0.85rem; bguild-radius: 4px; resize: vertical; }
        .agreement-item textarea:focus { outline: none; bguild-color: var(--gold); }
        .agreement-remove { width: 28px; height: 28px; background: transparent; bguild: 1px solid rgba(231, 76, 60, 0.3); color: rgba(231, 76, 60, 0.6); bguild-radius: 4px; cursor: pointer; font-size: 1rem; display: flex; align-items: center; justify-content: center; transition: all 0.15s; }
        .agreement-remove:hover { background: rgba(231, 76, 60, 0.1); bguild-color: #e74c3c; color: #e74c3c; }
        .add-agreement { background: transparent; bguild: 1px dashed rgba(201, 162, 39, 0.4); color: var(--gold); padding: 0.5rem 1rem; bguild-radius: 4px; font-family: inherit; font-size: 0.75rem; letter-spacing: 0.05em; cursor: pointer; transition: all 0.15s; }
        .add-agreement:hover { background: rgba(201, 162, 39, 0.05); bguild-color: var(--gold); bguild-style: solid; }
        .edit-status { font-size: 0.85rem; color: var(--gold); margin-top: 0.75rem; text-align: right; }
        .edit-status.error { color: #e74c3c; }
        /* Deck/Tasks styling */
        .deck-board { display: flex; flex-direction: column; gap: 0.5rem; }
        .deck-card { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 0.75rem; background: var(--black-light); bguild-left: 3px solid var(--gold); bguild-radius: 0 4px 4px 0; transition: all 0.2s ease; }
        .deck-card:hover { background: rgba(201, 162, 39, 0.1); padding-left: 1rem; }
        .deck-card-title { flex: 1; color: var(--white); font-size: 0.95rem; }
        .deck-card-due { font-size: 0.75rem; color: var(--gray); }
        .deck-card-due.overdue { color: #e74c3c; }
        .deck-card-labels { display: flex; gap: 0.25rem; }
        .deck-label { width: 8px; height: 8px; bguild-radius: 50%; }
        .deck-stack-name { font-size: 0.8rem; color: var(--gold); letter-spacing: 0.05em; text-transform: uppercase; margin-bottom: 0.5rem; padding-bottom: 0.25rem; bguild-bottom: 1px solid var(--gray-dark); }
        /* Panel actions & add button */
        .panel-actions { display: flex; align-items: center; gap: 0.5rem; margin-left: auto; }
        .panel-add-btn { width: 24px; height: 24px; border-radius: 4px; border: 1px solid var(--gray-dark); background: transparent; color: var(--gray); font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; line-height: 1; }
        .panel-add-btn:hover { border-color: var(--gold); color: var(--gold); background: rgba(201, 162, 39, 0.1); }

        /* Modal styles */
        .modal-overlay { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8); display: none; align-items: center; justify-content: center; z-index: 1000; backdrop-filter: blur(4px); }
        .modal-overlay.active { display: flex; }
        .modal-content { background: var(--black-light); border: 1px solid var(--gray-dark); border-radius: 12px; width: 90%; max-width: 500px; max-height: 90vh; overflow-y: auto; }
        .modal-header { display: flex; align-items: center; justify-content: space-between; padding: 1.25rem 1.5rem; border-bottom: 1px solid var(--gray-dark); }
        .modal-header h2 { font-size: 1.1rem; font-weight: 500; margin: 0; color: var(--white); }
        .modal-close { background: none; border: none; color: var(--gray); font-size: 1.5rem; cursor: pointer; padding: 0; line-height: 1; transition: color 0.2s; }
        .modal-close:hover { color: var(--gold); }
        .modal-form { padding: 1.5rem; display: flex; flex-direction: column; gap: 1.25rem; }
        .form-group { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-group label { font-size: 0.85rem; color: var(--gray-light); font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { background: var(--black); border: 1px solid var(--gray-dark); border-radius: 6px; padding: 0.75rem 1rem; color: var(--white); font-family: inherit; font-size: 0.9rem; transition: border-color 0.2s; }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus { outline: none; border-color: var(--gold); }
        .form-group textarea { resize: vertical; min-height: 100px; }
        .form-actions { display: flex; gap: 0.75rem; justify-content: flex-end; padding-top: 0.5rem; }
        .btn-primary { background: var(--gold); border: none; color: var(--black); padding: 0.65rem 1.25rem; border-radius: 6px; font-family: inherit; font-size: 0.9rem; font-weight: 500; cursor: pointer; transition: background 0.2s; }
        .btn-primary:hover { background: var(--gold-light); }
        .btn-secondary { background: transparent; border: 1px solid var(--gray-dark); color: var(--gray-light); padding: 0.65rem 1.25rem; border-radius: 6px; font-family: inherit; font-size: 0.9rem; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { border-color: var(--gray-light); color: var(--white); }
        .modal-body { padding: 1.5rem; }
        .scroll-view-meta { display: flex; align-items: center; gap: 0.5rem; color: var(--gray); font-size: 0.85rem; margin-bottom: 1rem; }
        .meta-sep { opacity: 0.5; }
        .scroll-view-content { color: var(--gray-light); line-height: 1.6; white-space: pre-wrap; }

        /* Scrolls styling */
        .scrolls-container { padding: 0.5rem 0; }
        .scrolls-toolbar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem; padding: 0 0.25rem; }
        .scrolls-count { font-size: 0.8rem; color: var(--gray); }
        .scrolls-empty { text-align: center; padding: 2rem 1rem; color: var(--gray); font-size: 0.9rem; }
        .scrolls-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .scroll-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--black-light); border-radius: 6px; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent; }
        .scroll-item:hover { background: rgba(201, 162, 39, 0.08); border-color: var(--gray-dark); }
        .scroll-type-icon { font-size: 1.25rem; }
        .scroll-info { flex: 1; min-width: 0; }
        .scroll-title { color: var(--white); font-size: 0.9rem; display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .scroll-meta { font-size: 0.75rem; color: var(--gray); }
        .scroll-actions { display: flex; gap: 0.25rem; opacity: 0; transition: opacity 0.2s; }
        .scroll-item:hover .scroll-actions { opacity: 1; }
        .scroll-action { background: none; border: 1px solid var(--gray-dark); color: var(--gray); width: 28px; height: 28px; border-radius: 4px; cursor: pointer; font-size: 0.85rem; transition: all 0.2s; display: flex; align-items: center; justify-content: center; }
        .scroll-action:hover { border-color: var(--gold); color: var(--gold); }
        .scroll-action.danger:hover { border-color: #c44; color: #c44; }

        /* Forms styling */
        .forms-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .form-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem; background: var(--black-light); bguild-radius: 6px; cursor: pointer; transition: all 0.2s ease; text-decoration: none; }
        .form-item:hover { background: rgba(201, 162, 39, 0.1); transform: translateX(4px); }
        .form-icon { font-size: 1.2rem; color: var(--gold); }
        .form-info { flex: 1; }
        .form-title { color: var(--white); font-size: 0.95rem; display: block; }
        .form-meta { font-size: 0.8rem; color: var(--gray); }
        .form-arrow { color: var(--gray); transition: color 0.2s; }
        .form-item:hover .form-arrow { color: var(--gold); }
    </style>
</head>
<body>
    <div class="app">
        <aside class="sidebar">
            <header class="sidebar-header"><a href="https://skymasons.xyz/" class="sigil-link" title="Brotherhood"><img src="/assets/logo.jpg" alt="Skymasons" class="sigil-logo"></a></header>
            <a href="guilds.html" class="browse-guilds-btn" title="Browse All Guilds">â˜° All Guilds</a>
            <nav class="guilds-list" id="guilds-list"><div class="loading">â‹¯</div></nav>
        </aside>
        <main class="main">
            <header class="main-header" id="main-header">
                <div class="user-profile">
                    <span class="user-name" id="user-name">Loading...</span>
                    <a href="https://sanctum.skymasons.xyz/settings.html" class="avatar-link" title="Settings">
                        <img class="user-avatar" id="user-avatar" src="" alt="">
                    </a>
                    <a href="https://auth.skymasons.xyz/if/flow/sanctum-logout/" class="logout-btn" title="Depart">â†—</a>
                </div>
            </header>
            <section class="guild-overview" id="guild-overview">
                <button class="guild-edit-btn" id="guild-edit-btn" title="Edit Guild">âœ Edit</button>
                <div class="guild-overview-icon" id="guild-icon">âœ¦</div>
                <h1 class="guild-overview-name" id="guild-name">Select a Guild</h1>
                <p class="guild-overview-desc" id="guild-desc"></p>
                <div class="guild-overview-meta" id="guild-meta"></div>
            </section>
            <section class="guild-edit-form" id="guild-edit-form">
                <h3>âš™ Guild Settings</h3>
                <div class="edit-field">
                    <label for="edit-name">Name</label>
                    <input type="text" id="edit-name" placeholder="Guild name">
                </div>
                <div class="edit-field">
                    <label for="edit-desc">Description</label>
                    <textarea id="edit-desc" rows="3" placeholder="Guild description"></textarea>
                </div>
                <div class="edit-row">
                    <div class="edit-field edit-field-small">
                        <label for="edit-color">Color</label>
                        <input type="color" id="edit-color" value="#c9a227">
                    </div>
                    <div class="edit-field edit-field-small">
                        <label for="edit-admission">Admission</label>
                        <select id="edit-admission">
                            <option value="open">Open</option>
                            <option value="closed">Closed</option>
                        </select>
                    </div>
                </div>
                <div class="symbol-picker">
                    <label>Symbol</label>
                    <div class="symbol-picker-header">
                        <div class="symbol-preview" id="edit-symbol-preview">âœ¦</div>
                        <select class="symbol-block-select" id="edit-symbol-block">
                            <option value="0x0370-0x03FF">Greek and Coptic</option>
                            <option value="0x0780-0x07BF">Thaana</option>
                            <option value="0x0800-0x083F">Samaritan</option>
                            <option value="0x16A0-0x16FF">Runic</option>
                            <option value="0x2000-0x206F">General Punctuation</option>
                            <option value="0x2200-0x22FF">Mathematical Operators</option>
                            <option value="0x2300-0x23FF">Miscellaneous Technical</option>
                            <option value="0x2580-0x259F">Block Elements</option>
                            <option value="0x25A0-0x25FF" selected>Geometric Shapes</option>
                            <option value="0x2600-0x26FF">Miscellaneous Symbols</option>
                            <option value="0x2700-0x27BF">Dingbats</option>
                            <option value="0x2B00-0x2BFF">Misc. Symbols & Arrows</option>
                        </select>
                    </div>
                    <div class="symbol-grid" id="edit-symbol-grid"></div>
                    <input type="hidden" id="edit-icon" value="âœ¦">
                </div>
                <div class="agreements-section">
                    <label>Application Agreements</label>
                    <div class="agreements-hint">Applicants must accept these agreements to join</div>
                    <div class="agreements-list" id="edit-agreements-list"></div>
                    <button type="button" class="add-agreement" id="add-agreement-btn">+ Add Agreement</button>
                </div>
                <div class="edit-actions">
                    <button class="edit-cancel-btn" id="edit-cancel-btn">Cancel</button>
                    <button class="edit-save-btn" id="edit-save-btn">Save Changes</button>
                </div>
            </section>
            <div class="panels" id="panels">
                <section class="panel" id="panel-chat">
                    <header class="panel-header"><span class="panel-toggle"><span class="collapse-icon">â–¼</span><span class="panel-icon">âˆ¿</span><h3>The Pulse</h3></span><a href="#" class="panel-link" id="chat-link" target="_blank">Open â†’</a></header>
                    <div class="panel-content" id="chat-content"><div class="empty-state">Select a guild to view the pulse</div></div>
                </section>
                <section class="panel" id="panel-calendar">
                    <header class="panel-header"><span class="panel-toggle"><span class="collapse-icon">â–¼</span><span class="panel-icon">â˜¾</span><h3>Rites</h3></span><a href="#" class="panel-link" id="calendar-link" target="_blank">Open â†’</a></header>
                    <div class="panel-content" id="calendar-content"><div class="empty-state">Select a guild to view rites</div></div>
                </section>
                <section class="panel" id="panel-deck">
                    <header class="panel-header"><span class="panel-toggle"><span class="collapse-icon">â–¼</span><span class="panel-icon">âš”</span><h3>Quests</h3></span><a href="#" class="panel-link" id="deck-link" target="_blank">Open â†’</a></header>
                    <div class="panel-content" id="deck-content"><div class="empty-state">Select a guild to view quests</div></div>
                </section>
                <section class="panel" id="panel-forms">
                    <header class="panel-header"><span class="panel-toggle"><span class="collapse-icon">â–¼</span><span class="panel-icon">âœ</span><h3>Scrolls</h3></span><div class="panel-actions"><button class="panel-add-btn" id="add-scroll-btn" title="Create Scroll">+</button></div></header>
                    <div class="panel-content" id="forms-content"><div class="empty-state">Select a guild to view scrolls</div></div>
                </section>
                <section class="panel" id="panel-files">
                    <header class="panel-header"><span class="panel-toggle"><span class="collapse-icon">â–¼</span><span class="panel-icon">â§«</span><h3>Archive</h3></span><a href="#" class="panel-link" id="files-link" target="_blank">Open â†’</a></header>
                    <div class="panel-content" id="files-content"><div class="empty-state">Select a guild to view files</div></div>
                </section>
                <section class="panel" id="panel-members">
                    <header class="panel-header"><span class="panel-toggle"><span class="collapse-icon">â–¼</span><span class="panel-icon">âšœ</span><h3>Brotherhood</h3></span><span class="panel-link" id="member-count">0</span></header>
                    <div class="panel-content" id="members-content"><div class="empty-state">Select a guild to view brotherhood</div></div>
                </section>
            </div>
        </main>
    </div>
    <script src="js/app.js"></script>
    <script>
// Emoji data for picker
const EMOJI_CATEGORIES = {
    frequent: { icon: 'ğŸ•', emojis: ['ğŸ‘', 'â¤ï¸', 'ğŸ˜‚', 'ğŸ‰', 'ğŸ”¥', 'ğŸ‘', 'ğŸ’¯', 'âœ¨', 'ğŸ™', 'ğŸ‘€'] },
    smileys: { icon: 'ğŸ˜€', emojis: ['ğŸ˜€','ğŸ˜ƒ','ğŸ˜„','ğŸ˜','ğŸ˜…','ğŸ˜‚','ğŸ¤£','ğŸ˜Š','ğŸ˜‡','ğŸ™‚','ğŸ˜‰','ğŸ˜Œ','ğŸ˜','ğŸ¥°','ğŸ˜˜','ğŸ˜—','ğŸ˜™','ğŸ˜š','ğŸ˜‹','ğŸ˜›','ğŸ˜œ','ğŸ¤ª','ğŸ˜','ğŸ¤‘','ğŸ¤—','ğŸ¤­','ğŸ¤«','ğŸ¤”','ğŸ¤','ğŸ¤¨','ğŸ˜','ğŸ˜‘','ğŸ˜¶','ğŸ˜','ğŸ˜’','ğŸ™„','ğŸ˜¬','ğŸ¤¥','ğŸ˜”','ğŸ˜ª','ğŸ¤¤','ğŸ˜´','ğŸ˜·','ğŸ¤’','ğŸ¤•','ğŸ¤¢','ğŸ¤®','ğŸ¤§','ğŸ¥µ','ğŸ¥¶','ğŸ¥´','ğŸ˜µ','ğŸ¤¯','ğŸ¤ ','ğŸ¥³','ğŸ˜','ğŸ¤“','ğŸ§','ğŸ˜•','ğŸ˜Ÿ','ğŸ™','â˜¹ï¸','ğŸ˜®','ğŸ˜¯','ğŸ˜²','ğŸ˜³','ğŸ¥º','ğŸ˜¦','ğŸ˜§','ğŸ˜¨','ğŸ˜°','ğŸ˜¥','ğŸ˜¢','ğŸ˜­','ğŸ˜±','ğŸ˜–','ğŸ˜£','ğŸ˜','ğŸ˜“','ğŸ˜©','ğŸ˜«','ğŸ¥±','ğŸ˜¤','ğŸ˜¡','ğŸ˜ ','ğŸ¤¬','ğŸ˜ˆ','ğŸ‘¿','ğŸ’€','â˜ ï¸','ğŸ’©','ğŸ¤¡','ğŸ‘¹','ğŸ‘º','ğŸ‘»','ğŸ‘½','ğŸ‘¾','ğŸ¤–'] },
    gestures: { icon: 'ğŸ‘‹', emojis: ['ğŸ‘‹','ğŸ¤š','ğŸ–ï¸','âœ‹','ğŸ––','ğŸ‘Œ','ğŸ¤Œ','ğŸ¤','âœŒï¸','ğŸ¤','ğŸ¤Ÿ','ğŸ¤˜','ğŸ¤™','ğŸ‘ˆ','ğŸ‘‰','ğŸ‘†','ğŸ–•','ğŸ‘‡','â˜ï¸','ğŸ‘','ğŸ‘','âœŠ','ğŸ‘Š','ğŸ¤›','ğŸ¤œ','ğŸ‘','ğŸ™Œ','ğŸ‘','ğŸ¤²','ğŸ¤','ğŸ™','âœï¸','ğŸ’…','ğŸ¤³','ğŸ’ª'] },
    people: { icon: 'ğŸ‘¤', emojis: ['ğŸ‘¶','ğŸ§’','ğŸ‘¦','ğŸ‘§','ğŸ§‘','ğŸ‘±','ğŸ‘¨','ğŸ§”','ğŸ‘©','ğŸ§“','ğŸ‘´','ğŸ‘µ','ğŸ™','ğŸ™','ğŸ™…','ğŸ™†','ğŸ’','ğŸ™‹','ğŸ§','ğŸ™‡','ğŸ¤¦','ğŸ¤·','ğŸ‘®','ğŸ•µï¸','ğŸ’‚','ğŸ¥·','ğŸ‘·','ğŸ¤´','ğŸ‘¸','ğŸ‘³','ğŸ‘²','ğŸ§•','ğŸ¤µ','ğŸ‘°','ğŸ¤°','ğŸ¤±','ğŸ‘¼','ğŸ…','ğŸ¤¶','ğŸ¦¸','ğŸ¦¹','ğŸ§™','ğŸ§š','ğŸ§›','ğŸ§œ','ğŸ§','ğŸ§','ğŸ§Ÿ'] },
    nature: { icon: 'ğŸ¶', emojis: ['ğŸ¶','ğŸ±','ğŸ­','ğŸ¹','ğŸ°','ğŸ¦Š','ğŸ»','ğŸ¼','ğŸ»â€â„ï¸','ğŸ¨','ğŸ¯','ğŸ¦','ğŸ®','ğŸ·','ğŸ¸','ğŸµ','ğŸ™ˆ','ğŸ™‰','ğŸ™Š','ğŸ’','ğŸ”','ğŸ§','ğŸ¦','ğŸ¤','ğŸ£','ğŸ¥','ğŸ¦†','ğŸ¦…','ğŸ¦‰','ğŸ¦‡','ğŸº','ğŸ—','ğŸ´','ğŸ¦„','ğŸ','ğŸ›','ğŸ¦‹','ğŸŒ','ğŸ','ğŸœ','ğŸ¦Ÿ','ğŸ¦—','ğŸ•·ï¸','ğŸ¦‚','ğŸ¢','ğŸ','ğŸ¦','ğŸ¦–','ğŸ¦•','ğŸ™','ğŸ¦‘','ğŸ¦','ğŸ¦','ğŸ¦€','ğŸ¡','ğŸ ','ğŸŸ','ğŸ¬','ğŸ³','ğŸ‹','ğŸ¦ˆ','ğŸŠ','ğŸ…','ğŸ†','ğŸ¦“','ğŸ¦','ğŸ¦§','ğŸ˜','ğŸ¦›','ğŸ¦','ğŸª','ğŸ«','ğŸ¦’','ğŸ¦˜','ğŸƒ','ğŸ‚','ğŸ„','ğŸ','ğŸ–','ğŸ','ğŸ‘','ğŸ¦™','ğŸ','ğŸ¦Œ','ğŸ•','ğŸ©','ğŸ¦®','ğŸˆ','ğŸ“','ğŸ¦ƒ','ğŸ¦š','ğŸ¦œ','ğŸ¦¢','ğŸ¦©','ğŸ•Šï¸','ğŸ‡','ğŸ¦','ğŸ¦¨','ğŸ¦¡','ğŸ¦«','ğŸ¦¦','ğŸ¦¥','ğŸ','ğŸ€','ğŸ¿ï¸','ğŸ¦”'] },
    food: { icon: 'ğŸ', emojis: ['ğŸ‡','ğŸˆ','ğŸ‰','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ','ğŸ¥­','ğŸ','ğŸ','ğŸ','ğŸ‘','ğŸ’','ğŸ“','ğŸ«','ğŸ¥','ğŸ…','ğŸ«’','ğŸ¥¥','ğŸ¥‘','ğŸ†','ğŸ¥”','ğŸ¥•','ğŸŒ½','ğŸŒ¶ï¸','ğŸ«‘','ğŸ¥’','ğŸ¥¬','ğŸ¥¦','ğŸ§„','ğŸ§…','ğŸ„','ğŸ¥œ','ğŸŒ°','ğŸ','ğŸ¥','ğŸ¥–','ğŸ«“','ğŸ¥¨','ğŸ¥¯','ğŸ¥','ğŸ§‡','ğŸ§€','ğŸ–','ğŸ—','ğŸ¥©','ğŸ¥“','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ­','ğŸ¥ª','ğŸŒ®','ğŸŒ¯','ğŸ«”','ğŸ¥™','ğŸ§†','ğŸ¥š','ğŸ³','ğŸ¥˜','ğŸ²','ğŸ«•','ğŸ¥£','ğŸ¥—','ğŸ¿','ğŸ§ˆ','ğŸ§‚','ğŸ¥«','ğŸ±','ğŸ˜','ğŸ™','ğŸš','ğŸ›','ğŸœ','ğŸ','ğŸ ','ğŸ¢','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¥®','ğŸ¡','ğŸ¥Ÿ','ğŸ¥ ','ğŸ¥¡','ğŸ¦€','ğŸ¦','ğŸ¦','ğŸ¦‘','ğŸ¦ª','ğŸ¦','ğŸ§','ğŸ¨','ğŸ©','ğŸª','ğŸ‚','ğŸ°','ğŸ§','ğŸ¥§','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ¯','ğŸ¼','ğŸ¥›','â˜•','ğŸ«–','ğŸµ','ğŸ¶','ğŸ¾','ğŸ·','ğŸ¸','ğŸ¹','ğŸº','ğŸ»','ğŸ¥‚','ğŸ¥ƒ','ğŸ¥¤','ğŸ§‹','ğŸ§ƒ','ğŸ§‰','ğŸ§Š'] },
    activities: { icon: 'âš½', emojis: ['âš½','ğŸ€','ğŸˆ','âš¾','ğŸ¥','ğŸ¾','ğŸ','ğŸ‰','ğŸ¥','ğŸ±','ğŸª€','ğŸ“','ğŸ¸','ğŸ’','ğŸ‘','ğŸ¥','ğŸ','ğŸªƒ','ğŸ¥…','â›³','ğŸª','ğŸ¹','ğŸ£','ğŸ¤¿','ğŸ¥Š','ğŸ¥‹','ğŸ½','ğŸ›¹','ğŸ›¼','ğŸ›·','â›¸ï¸','ğŸ¥Œ','ğŸ¿','â›·ï¸','ğŸ‚','ğŸª‚','ğŸ†','ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰','ğŸ…','ğŸ–ï¸','ğŸµï¸','ğŸ—ï¸','ğŸ«','ğŸŸï¸','ğŸª','ğŸ¤¹','ğŸ­','ğŸ©°','ğŸ¨','ğŸ¬','ğŸ¤','ğŸ§','ğŸ¼','ğŸ¹','ğŸ¥','ğŸª˜','ğŸ·','ğŸº','ğŸª—','ğŸ¸','ğŸª•','ğŸ»','ğŸ²','â™Ÿï¸','ğŸ¯','ğŸ³','ğŸ®','ğŸ°','ğŸ§©'] },
    travel: { icon: 'ğŸš—', emojis: ['ğŸš—','ğŸš•','ğŸš™','ğŸšŒ','ğŸš','ğŸï¸','ğŸš“','ğŸš‘','ğŸš’','ğŸš','ğŸ›»','ğŸšš','ğŸš›','ğŸšœ','ğŸ›´','ğŸš²','ğŸ›µ','ğŸï¸','ğŸš¨','ğŸš”','ğŸš','ğŸš˜','ğŸš–','ğŸš¡','ğŸš ','ğŸšŸ','ğŸšƒ','ğŸš‹','ğŸš','ğŸš','ğŸš„','ğŸš…','ğŸšˆ','ğŸš‚','ğŸš†','ğŸš‡','ğŸšŠ','ğŸš‰','âœˆï¸','ğŸ›«','ğŸ›¬','ğŸ›©ï¸','ğŸ’º','ğŸ›°ï¸','ğŸš€','ğŸ›¸','ğŸš','ğŸ›¶','â›µ','ğŸš¤','ğŸ›¥ï¸','ğŸ›³ï¸','â›´ï¸','ğŸš¢','âš“','ğŸª','â›½','ğŸš§','ğŸš¦','ğŸš¥','ğŸš','ğŸ—ºï¸','ğŸ—¿','ğŸ—½','ğŸ—¼','ğŸ°','ğŸ¯','ğŸŸï¸','ğŸ¡','ğŸ¢','ğŸ ','â›²','â›±ï¸','ğŸ–ï¸','ğŸï¸','ğŸœï¸','ğŸŒ‹','â›°ï¸','ğŸ”ï¸','ğŸ—»','ğŸ•ï¸','â›º','ğŸ›–','ğŸ ','ğŸ¡','ğŸ˜ï¸','ğŸšï¸','ğŸ—ï¸','ğŸ­','ğŸ¢','ğŸ¬','ğŸ£','ğŸ¤','ğŸ¥','ğŸ¦','ğŸ¨','ğŸª','ğŸ«','ğŸ©','ğŸ’’','ğŸ›ï¸','â›ª','ğŸ•Œ','ğŸ•','ğŸ›•','ğŸ•‹','â›©ï¸'] },
    objects: { icon: 'ğŸ’¡', emojis: ['âŒš','ğŸ“±','ğŸ“²','ğŸ’»','âŒ¨ï¸','ğŸ–¥ï¸','ğŸ–¨ï¸','ğŸ–±ï¸','ğŸ–²ï¸','ğŸ•¹ï¸','ğŸ’½','ğŸ’¾','ğŸ’¿','ğŸ“€','ğŸ“¼','ğŸ“·','ğŸ“¸','ğŸ“¹','ğŸ¥','ğŸ“½ï¸','ğŸï¸','ğŸ“','â˜ï¸','ğŸ“Ÿ','ğŸ“ ','ğŸ“º','ğŸ“»','ğŸ™ï¸','ğŸšï¸','ğŸ›ï¸','ğŸ§­','â±ï¸','â²ï¸','â°','ğŸ•°ï¸','âŒ›','â³','ğŸ“¡','ğŸ”‹','ğŸ”Œ','ğŸ’¡','ğŸ”¦','ğŸ•¯ï¸','ğŸª”','ğŸ§¯','ğŸ›¢ï¸','ğŸ’¸','ğŸ’µ','ğŸ’´','ğŸ’¶','ğŸ’·','ğŸª™','ğŸ’°','ğŸ’³','ğŸ’','âš–ï¸','ğŸªœ','ğŸ§°','ğŸª›','ğŸ”§','ğŸ”¨','âš’ï¸','ğŸ› ï¸','â›ï¸','ğŸªš','ğŸ”©','âš™ï¸','ğŸ”«','ğŸ’£','ğŸ§¨','ğŸª“','ğŸ”ª','ğŸ—¡ï¸','âš”ï¸','ğŸ›¡ï¸','ğŸ”®','ğŸ“¿','ğŸ§¿','ğŸ’ˆ','âš—ï¸','ğŸ”­','ğŸ”¬','ğŸ•³ï¸','ğŸ©¹','ğŸ©º','ğŸ’Š','ğŸ’‰','ğŸ©¸','ğŸ§¬','ğŸ¦ ','ğŸ§«','ğŸ§ª','ğŸŒ¡ï¸','ğŸ§¹','ğŸª ','ğŸ§º','ğŸ§»','ğŸš½','ğŸš°','ğŸš¿','ğŸ›','ğŸ§¼','ğŸª¥','ğŸª’','ğŸ§½','ğŸ›ï¸','ğŸ”‘','ğŸ—ï¸','ğŸšª','ğŸª‘','ğŸ›‹ï¸','ğŸ›ï¸','ğŸ§¸','ğŸ–¼ï¸','ğŸ›ï¸','ğŸ›’','ğŸ','ğŸˆ','ğŸ','ğŸ€','ğŸª„','ğŸŠ','ğŸ‰','ğŸ','ğŸ®','ğŸ','ğŸ§§','âœ‰ï¸','ğŸ“©','ğŸ“¨','ğŸ“§','ğŸ’Œ','ğŸ“¥','ğŸ“¤','ğŸ“¦','ğŸ·ï¸','ğŸ“ª','ğŸ“«','ğŸ“¬','ğŸ“­','ğŸ“®','ğŸ“¯','ğŸ“œ','ğŸ“ƒ','ğŸ“„','ğŸ“‘','ğŸ§¾','ğŸ“Š','ğŸ“ˆ','ğŸ“‰','ğŸ“†','ğŸ“…','ğŸ—‘ï¸','ğŸ“‡','ğŸ—ƒï¸','ğŸ—³ï¸','ğŸ—„ï¸','ğŸ“‹','ğŸ“','ğŸ“‚','ğŸ—‚ï¸','ğŸ—ï¸','ğŸ“°','ğŸ““','ğŸ“”','ğŸ“’','ğŸ“•','ğŸ“—','ğŸ“˜','ğŸ“™','ğŸ“š','ğŸ“–','ğŸ”–','ğŸ”—','ğŸ“','ğŸ–‡ï¸','ğŸ“','ğŸ“','ğŸ§®','ğŸ“Œ','ğŸ“','âœ‚ï¸','ğŸ–Šï¸','ğŸ–‹ï¸','âœ’ï¸','ğŸ–Œï¸','ğŸ–ï¸','ğŸ“','âœï¸','ğŸ”','ğŸ”','ğŸ”','ğŸ”','ğŸ”’','ğŸ”“'] },
    symbols: { icon: 'â¤ï¸', emojis: ['â¤ï¸','ğŸ§¡','ğŸ’›','ğŸ’š','ğŸ’™','ğŸ’œ','ğŸ–¤','ğŸ¤','ğŸ¤','ğŸ’”','â£ï¸','ğŸ’•','ğŸ’','ğŸ’“','ğŸ’—','ğŸ’–','ğŸ’˜','ğŸ’','ğŸ’Ÿ','â˜®ï¸','âœï¸','â˜ªï¸','ğŸ•‰ï¸','â˜¸ï¸','âœ¡ï¸','ğŸ”¯','ğŸ•','â˜¯ï¸','â˜¦ï¸','ğŸ›','â›','â™ˆ','â™‰','â™Š','â™‹','â™Œ','â™','â™','â™','â™','â™‘','â™’','â™“','ğŸ†”','âš›ï¸','â˜¢ï¸','â˜£ï¸','ğŸ“´','ğŸ“³','ğŸˆ¶','ğŸˆš','ğŸˆ¸','ğŸˆº','ğŸˆ·ï¸','âœ´ï¸','ğŸ†š','ğŸ’®','ğŸ‰','ãŠ™ï¸','ãŠ—ï¸','ğŸˆ´','ğŸˆµ','ğŸˆ¹','ğŸˆ²','ğŸ…°ï¸','ğŸ…±ï¸','ğŸ†','ğŸ†‘','ğŸ…¾ï¸','ğŸ†˜','âŒ','â­•','ğŸ›‘','â›”','ğŸ“›','ğŸš«','ğŸ’¯','ğŸ’¢','â™¨ï¸','ğŸš·','ğŸš¯','ğŸš³','ğŸš±','ğŸ”','ğŸ“µ','ğŸš­','â—','â•','â“','â”','â€¼ï¸','â‰ï¸','ğŸ”…','ğŸ”†','ã€½ï¸','âš ï¸','ğŸš¸','ğŸ”±','âšœï¸','ğŸ”°','â™»ï¸','âœ…','ğŸˆ¯','ğŸ’¹','â‡ï¸','âœ³ï¸','â','ğŸŒ','ğŸ’ ','â“‚ï¸','ğŸŒ€','ğŸ’¤','ğŸ§','ğŸš¾','â™¿','ğŸ…¿ï¸','ğŸ›—','ğŸˆ³','ğŸˆ‚ï¸','ğŸ›‚','ğŸ›ƒ','ğŸ›„','ğŸ›…','ğŸš¹','ğŸšº','ğŸš¼','âš§ï¸','ğŸš»','ğŸš®','ğŸ¦','ğŸ“¶','ğŸˆ','ğŸ”£','â„¹ï¸','ğŸ”¤','ğŸ”¡','ğŸ” ','ğŸ†–','ğŸ†—','ğŸ†™','ğŸ†’','ğŸ†•','ğŸ†“','0ï¸âƒ£','1ï¸âƒ£','2ï¸âƒ£','3ï¸âƒ£','4ï¸âƒ£','5ï¸âƒ£','6ï¸âƒ£','7ï¸âƒ£','8ï¸âƒ£','9ï¸âƒ£','ğŸ”Ÿ','ğŸ”¢','#ï¸âƒ£','*ï¸âƒ£','âï¸','â–¶ï¸','â¸ï¸','â¯ï¸','â¹ï¸','âºï¸','â­ï¸','â®ï¸','â©','âª','â«','â¬','â—€ï¸','ğŸ”¼','ğŸ”½','â¡ï¸','â¬…ï¸','â¬†ï¸','â¬‡ï¸','â†—ï¸','â†˜ï¸','â†™ï¸','â†–ï¸','â†•ï¸','â†”ï¸','â†ªï¸','â†©ï¸','â¤´ï¸','â¤µï¸','ğŸ”€','ğŸ”','ğŸ”‚','ğŸ”„','ğŸ”ƒ','ğŸµ','ğŸ¶','â•','â–','â—','âœ–ï¸','ğŸŸ°','â™¾ï¸','ğŸ’²','ğŸ’±','â„¢ï¸','Â©ï¸','Â®ï¸','ã€°ï¸','â°','â¿','ğŸ”š','ğŸ”™','ğŸ”›','ğŸ”','ğŸ”œ','âœ”ï¸','â˜‘ï¸','ğŸ”˜','ğŸ”´','ğŸŸ ','ğŸŸ¡','ğŸŸ¢','ğŸ”µ','ğŸŸ£','âš«','âšª','ğŸŸ¤','ğŸ”º','ğŸ”»','ğŸ”¸','ğŸ”¹','ğŸ”¶','ğŸ”·','ğŸ”³','ğŸ”²','â–ªï¸','â–«ï¸','â—¾','â—½','â—¼ï¸','â—»ï¸','ğŸŸ¥','ğŸŸ§','ğŸŸ¨','ğŸŸ©','ğŸŸ¦','ğŸŸª','â¬›','â¬œ','ğŸŸ«','ğŸ”ˆ','ğŸ”‡','ğŸ”‰','ğŸ”Š','ğŸ””','ğŸ”•','ğŸ“£','ğŸ“¢','ğŸ’¬','ğŸ’­','ğŸ—¯ï¸','â™ ï¸','â™£ï¸','â™¥ï¸','â™¦ï¸','ğŸƒ','ğŸ´','ğŸ€„'] }
};

// Emoji Picker
const EmojiPicker = {
    isOpen: false,
    messageId: null,
    category: 'frequent',

    open(msgId, btn) {
        this.close();
        this.isOpen = true;
        this.messageId = msgId;
        this.category = 'frequent';
        this.render(btn);
    },

    close() {
        this.isOpen = false;
        this.messageId = null;
        document.querySelectorAll('.emoji-picker, .emoji-picker-overlay').forEach(el => el.remove());
    },

    render(anchor) {
        const overlay = document.createElement('div');
        overlay.className = 'emoji-picker-overlay';
        overlay.onclick = () => this.close();
        document.body.appendChild(overlay);

        const picker = document.createElement('div');
        picker.className = 'emoji-picker';
        picker.innerHTML = this.getHTML();
        document.body.appendChild(picker);

        // Position
        const rect = anchor.getBoundingClientRect();
        let top = rect.bottom + 4;
        let left = rect.left;
        if (left + 280 > window.innerWidth) left = window.innerWidth - 290;
        if (top + 320 > window.innerHeight) top = rect.top - 324;
        picker.style.top = top + 'px';
        picker.style.left = left + 'px';

        this.bind(picker);
    },

    getHTML() {
        const cats = Object.entries(EMOJI_CATEGORIES);
        return `
            <div class="emoji-picker-header">
                <input type="text" class="emoji-search" placeholder="Search..." id="emoji-search">
            </div>
            <div class="emoji-tabs">
                ${cats.map(([k, v]) => `<button class="emoji-tab ${k === this.category ? 'active' : ''}" data-cat="${k}">${v.icon}</button>`).join('')}
            </div>
            <div class="emoji-grid-wrap"><div class="emoji-grid" id="emoji-grid">
                ${this.getEmojis()}
            </div></div>
        `;
    },

    getEmojis(filter = '') {
        let emojis = EMOJI_CATEGORIES[this.category]?.emojis || [];
        if (filter) {
            emojis = Object.values(EMOJI_CATEGORIES).flatMap(c => c.emojis);
        }
        return emojis.map(e => `<button class="emoji-btn" data-emoji="${e}">${e}</button>`).join('');
    },

    bind(picker) {
        picker.onclick = e => e.stopPropagation();
        picker.querySelectorAll('.emoji-tab').forEach(tab => {
            tab.onclick = () => {
                this.category = tab.dataset.cat;
                picker.querySelectorAll('.emoji-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                picker.querySelector('#emoji-grid').innerHTML = this.getEmojis();
                this.bindEmojis(picker);
            };
        });
        const search = picker.querySelector('#emoji-search');
        search.oninput = () => {
            picker.querySelector('#emoji-grid').innerHTML = this.getEmojis(search.value);
            this.bindEmojis(picker);
        };
        search.focus();
        this.bindEmojis(picker);
    },

    bindEmojis(picker) {
        picker.querySelectorAll('.emoji-btn').forEach(btn => {
            btn.onclick = () => this.select(btn.dataset.emoji);
        });
    },

    async select(emoji) {
        const msgId = this.messageId;
        this.close();
        if (msgId && App.currentTalkRoom) {
            try {
                await API.addReaction(App.currentTalkRoom, msgId, emoji);
                App.loadChat(State.currentGuild);
            } catch (e) { console.error('Reaction failed:', e); }
        }
    }
};

// Extend UI with due date formatting
UI.formatDueDate = function(dateStr) {
UI.formatDate = function(dateStr) {
    const date = new Date(dateStr);
    return date.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
};
    const date = new Date(dateStr);
    const now = new Date();
    const diffDays = Math.ceil((date - now) / (1000 * 60 * 60 * 24));
    if (diffDays < 0) return `${Math.abs(diffDays)}d overdue`;
    if (diffDays === 0) return 'Today';
    if (diffDays === 1) return 'Tomorrow';
    if (diffDays < 7) return `${diffDays}d`;
    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
};

// Extend API with reaction and file management methods
API.addReaction = async function(roomToken, messageId, reaction) {
    return this.fetch(`/chat/${roomToken}/messages/${messageId}/reactions`, {
        method: 'POST',
        body: JSON.stringify({ reaction })
    });
};
API.removeReaction = async function(roomToken, messageId, reaction) {
    return this.fetch(`/chat/${roomToken}/messages/${messageId}/reactions/${encodeURIComponent(reaction)}`, {
        method: 'DELETE'
    });
};
API.getDeckCards = async function(boardId) {
    return this.fetch(`/deck/${boardId}/cards`);
};
API.uploadFile = async function(folderId, folderName, file) {
    const formData = new FormData();
    formData.append('file', file);
    const response = await fetch(`${this.baseUrl}/files/${folderId}/upload`, {
        method: 'POST',
        credentials: 'include',
        body: formData
    });
    if (!response.ok) throw new Error(`Upload error: ${response.status}`);
    return response.json();
};
API.deleteFile = async function(fileId) {
    return this.fetch(`/files/${fileId}`, { method: 'DELETE' });
};
API.createShareLink = async function(fileId) {
    return this.fetch(`/files/${fileId}/share`, { method: 'POST' });
};
API.createFolder = async function(parentFolderId, folderName) {
    return this.fetch(`/files/${parentFolderId}/folder`, {
        method: 'POST',
        body: JSON.stringify({ name: folderName })
    });
};
API.updateGuild = async function(guildId, updates) {
    return this.fetch(`/guilds/${encodeURIComponent(guildId)}`, {
        method: 'PUT',
        body: JSON.stringify(updates)
    });
};

let currentEditGuild = null;
let currentEditGuildId = null;
let selectedSymbol = 'âœ¦';
let selectedCodePoint = 0x2726;

const unicodeBlocks = {
    "0x0370-0x03FF": { name: "Greek and Coptic", start: 0x0370, end: 0x03FF },
    "0x0780-0x07BF": { name: "Thaana", start: 0x0780, end: 0x07BF },
    "0x0800-0x083F": { name: "Samaritan", start: 0x0800, end: 0x083F },
    "0x16A0-0x16FF": { name: "Runic", start: 0x16A0, end: 0x16FF },
    "0x2000-0x206F": { name: "General Punctuation", start: 0x2000, end: 0x206F },
    "0x2200-0x22FF": { name: "Mathematical Operators", start: 0x2200, end: 0x22FF },
    "0x2300-0x23FF": { name: "Miscellaneous Technical", start: 0x2300, end: 0x23FF },
    "0x2580-0x259F": { name: "Block Elements", start: 0x2580, end: 0x259F },
    "0x25A0-0x25FF": { name: "Geometric Shapes", start: 0x25A0, end: 0x25FF },
    "0x2600-0x26FF": { name: "Miscellaneous Symbols", start: 0x2600, end: 0x26FF },
    "0x2700-0x27BF": { name: "Dingbats", start: 0x2700, end: 0x27BF },
    "0x2B00-0x2BFF": { name: "Miscellaneous Symbols and Arrows", start: 0x2B00, end: 0x2BFF }
};

function isPrintableChar(cp) {
    if (cp < 0x20) return false;
    if (cp >= 0x7F && cp <= 0x9F) return false;
    if (cp >= 0xD800 && cp <= 0xDFFF) return false;
    if (cp >= 0xFDD0 && cp <= 0xFDEF) return false;
    if ((cp & 0xFFFE) === 0xFFFE) return false;
    const invisibles = [0x00AD, 0x034F, 0x061C, 0x115F, 0x1160, 0x17B4, 0x17B5, 0x180B, 0x180C, 0x180D, 0x180E, 0x200B, 0x200C, 0x200D, 0x200E, 0x200F, 0x202A, 0x202B, 0x202C, 0x202D, 0x202E, 0x2060, 0x2061, 0x2062, 0x2063, 0x2064, 0x206A, 0x206B, 0x206C, 0x206D, 0x206E, 0x206F, 0xFEFF, 0xFFA0];
    return !invisibles.includes(cp);
}

function populateSymbolGrid(blockKey) {
    const grid = UI.$('#edit-symbol-grid');
    grid.innerHTML = '';
    const block = unicodeBlocks[blockKey];
    if (!block) return;
    for (let cp = block.start; cp <= block.end; cp++) {
        if (!isPrintableChar(cp)) continue;
        const char = String.fromCodePoint(cp);
        const item = document.createElement('div');
        item.className = 'symbol-item' + (cp === selectedCodePoint ? ' selected' : '');
        item.textContent = char;
        item.dataset.codepoint = cp;
        item.title = 'U+' + cp.toString(16).toUpperCase().padStart(4, '0');
        item.onclick = () => selectSymbol(char, cp);
        grid.appendChild(item);
    }
}

function selectSymbol(char, cp) {
    selectedSymbol = char;
    selectedCodePoint = cp;
    UI.$('#edit-symbol-preview').textContent = char;
    UI.$('#edit-icon').value = char;
    UI.$$('#edit-symbol-grid .symbol-item').forEach(el => {
        el.classList.toggle('selected', parseInt(el.dataset.codepoint) === cp);
    });
}

function renderAgreements(agreements) {
    const list = UI.$('#edit-agreements-list');
    list.innerHTML = '';
    (agreements || []).forEach((text, idx) => {
        const item = document.createElement('div');
        item.className = 'agreement-item';
        item.innerHTML = `
            <textarea placeholder="Agreement text...">${UI.escapeHtml(text)}</textarea>
            <button type="button" class="agreement-remove" data-idx="${idx}">&times;</button>
        `;
        list.appendChild(item);
    });
    list.querySelectorAll('.agreement-remove').forEach(btn => {
        btn.onclick = () => btn.closest('.agreement-item').remove();
    });
}

function getAgreements() {
    return Array.from(UI.$$('#edit-agreements-list textarea')).map(t => t.value.trim()).filter(t => t);
}

function toggleEditForm(guild, guildId) {
    const form = UI.$('#guild-edit-form');
    const isActive = form.classList.contains('active');

    if (isActive) {
        form.classList.remove('active');
        currentEditGuild = null;
        currentEditGuildId = null;
    } else {
        currentEditGuild = guild;
        currentEditGuildId = guildId;
        UI.$('#edit-name').value = guild.name || '';
        UI.$('#edit-desc').value = guild.description || '';
        UI.$('#edit-color').value = guild.color || '#c9a227';
        UI.$('#edit-admission').value = guild.admission || 'open';

        // Symbol picker
        const icon = guild.icon || 'âœ¦';
        selectedSymbol = icon;
        selectedCodePoint = icon.codePointAt(0);
        UI.$('#edit-symbol-preview').textContent = icon;
        UI.$('#edit-icon').value = icon;
        populateSymbolGrid(UI.$('#edit-symbol-block').value);

        // Agreements
        renderAgreements(guild.agreements || []);

        form.classList.add('active');
    }
}

function initEditForm() {
    // Symbol block selector
    UI.$('#edit-symbol-block').addEventListener('change', (e) => {
        populateSymbolGrid(e.target.value);
    });

    // Add agreement button
    UI.$('#add-agreement-btn').addEventListener('click', () => {
        const list = UI.$('#edit-agreements-list');
        const item = document.createElement('div');
        item.className = 'agreement-item';
        item.innerHTML = `
            <textarea placeholder="Agreement text..."></textarea>
            <button type="button" class="agreement-remove">&times;</button>
        `;
        item.querySelector('.agreement-remove').onclick = () => item.remove();
        list.appendChild(item);
        item.querySelector('textarea').focus();
    });

    UI.$('#edit-cancel-btn').addEventListener('click', () => {
        UI.$('#guild-edit-form').classList.remove('active');
        currentEditGuild = null;
        currentEditGuildId = null;
    });

    UI.$('#edit-save-btn').addEventListener('click', async () => {
        if (!currentEditGuildId) return;

        const btn = UI.$('#edit-save-btn');
        btn.disabled = true;
        btn.textContent = 'Saving...';

        try {
            const updates = {
                name: UI.$('#edit-name').value.trim(),
                description: UI.$('#edit-desc').value.trim(),
                icon: UI.$('#edit-icon').value.trim() || 'âœ¦',
                color: UI.$('#edit-color').value,
                admission: UI.$('#edit-admission').value,
                agreements: getAgreements()
            };

            await API.updateGuild(currentEditGuildId, updates);

            UI.$('#guild-edit-form').classList.remove('active');
            UI.$('#guild-name').textContent = updates.name;
            UI.$('#guild-desc').textContent = updates.description;
            UI.$('#guild-icon').textContent = updates.icon;
            UI.$('#guild-icon').style.color = updates.color;

            const item = document.querySelector(`.guild-item[data-guild-id="${currentEditGuildId}"]`);
            if (item) {
                const iconEl = item.querySelector('.guild-icon');
                iconEl.textContent = updates.icon;
                iconEl.style.color = updates.color;
                item.setAttribute('data-tooltip', updates.name);
            }

            currentEditGuild = null;
            currentEditGuildId = null;
        } catch (e) {
            console.error('Failed to save guild:', e);
            alert('Failed to save changes. Please try again.');
        } finally {
            btn.disabled = false;
            btn.textContent = 'Save Changes';
        }
    });
}

function initScrollModal() {
    const modal = UI.$("#scroll-modal");
    const viewModal = UI.$("#scroll-view-modal");
    const form = UI.$("#scroll-form");
    const addBtn = UI.$("#add-scroll-btn");
    const closeBtn = UI.$("#scroll-modal-close");
    const cancelBtn = UI.$("#scroll-cancel");
    const viewCloseBtn = UI.$("#scroll-view-close");

    const openModal = () => {
        delete modal.dataset.editId;
        form.reset();
        modal.classList.add("active");
    };
    const closeModal = () => {
        modal.classList.remove("active");
        delete modal.dataset.editId;
        form.reset();
    };
    const closeViewModal = () => viewModal.classList.remove("active");

    addBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);
    cancelBtn.addEventListener("click", closeModal);
    modal.addEventListener("click", (e) => { if (e.target === modal) closeModal(); });

    viewCloseBtn.addEventListener("click", closeViewModal);
    viewModal.addEventListener("click", (e) => { if (e.target === viewModal) closeViewModal(); });

    form.addEventListener("submit", async (e) => {
        e.preventDefault();
        const guildId = App.currentGuildId;
        if (!guildId) return;
        
        const data = {
            title: UI.$("#scroll-title").value,
            type: UI.$("#scroll-type").value,
            content: UI.$("#scroll-content").value
        };
        
        if (modal.dataset.editId) {
            ScrollsManager.updateScroll(guildId, modal.dataset.editId, data);
        } else {
            ScrollsManager.createScroll(guildId, data);
        }
        
        closeModal();
        App.loadForms(State.currentGuild);
    });
}

const ScrollsManager = {
    STORAGE_KEY: "sanctum_scrolls",

    getScrolls(guildId) {
        const all = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || "{}");
        return all[guildId] || [];
    },

    saveScrolls(guildId, scrolls) {
        const all = JSON.parse(localStorage.getItem(this.STORAGE_KEY) || "{}");
        all[guildId] = scrolls;
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(all));
    },

    createScroll(guildId, data) {
        const scrolls = this.getScrolls(guildId);
        const scroll = {
            id: Date.now().toString(),
            title: data.title,
            type: data.type,
            content: data.content,
            created: new Date().toISOString(),
            updated: new Date().toISOString()
        };
        scrolls.unshift(scroll);
        this.saveScrolls(guildId, scrolls);
        return scroll;
    },

    getScroll(guildId, scrollId) {
        const scrolls = this.getScrolls(guildId);
        return scrolls.find(s => s.id === scrollId);
    },

    updateScroll(guildId, scrollId, data) {
        const scrolls = this.getScrolls(guildId);
        const index = scrolls.findIndex(s => s.id === scrollId);
        if (index \!== -1) {
            scrolls[index] = { ...scrolls[index], ...data, updated: new Date().toISOString() };
            this.saveScrolls(guildId, scrolls);
        }
    },

    deleteScroll(guildId, scrollId) {
        if (\!confirm("Delete this scroll?")) return;
        const scrolls = this.getScrolls(guildId).filter(s => s.id \!== scrollId);
        this.saveScrolls(guildId, scrolls);
        App.loadForms(State.currentGuild);
    },

    viewScroll(guildId, scrollId) {
        const scroll = this.getScroll(guildId, scrollId);
        if (\!scroll) return;
        const modal = UI.$("#scroll-view-modal");
        UI.$("#view-scroll-title").textContent = scroll.title;
        UI.$("#view-scroll-type").textContent = this.getTypeIcon(scroll.type) + " " + this.getTypeName(scroll.type);
        UI.$("#view-scroll-date").textContent = UI.formatDate(scroll.created);
        UI.$("#view-scroll-content").textContent = scroll.content || "(No content)";
        modal.classList.add("active");
    },

    editScroll(guildId, scrollId) {
        const scroll = this.getScroll(guildId, scrollId);
        if (\!scroll) return;
        const modal = UI.$("#scroll-modal");
        UI.$("#scroll-title").value = scroll.title;
        UI.$("#scroll-type").value = scroll.type;
        UI.$("#scroll-content").value = scroll.content || "";
        modal.dataset.editId = scrollId;
        modal.classList.add("active");
    },

    getTypeIcon(type) {
        const icons = { petition: "ğŸ“œ", poll: "ğŸ“Š", inquiry: "â“", announcement: "ğŸ“¢" };
        return icons[type] || "ğŸ“„";
    },

    getTypeName(type) {
        const names = { petition: "Petition", poll: "Poll", inquiry: "Inquiry", announcement: "Announcement" };
        return names[type] || "Scroll";
    }
};

const App = {
    currentGuildId: null,
    currentTalkRoom: null,
    folderStack: [],
    PINNED_GUILD: 'the-brotherhood',
    STORAGE_KEY: 'sanctum_recent_guilds',
    COLLAPSED_KEY: 'sanctum_collapsed_panels',

    setupCollapsiblePanels() {
        const collapsed = this.getCollapsedPanels();
        UI.$$('.panel-toggle').forEach(toggle => {
            const panel = toggle.closest('.panel');
            const panelId = panel.id;
            if (collapsed.includes(panelId)) panel.classList.add('collapsed');
            toggle.addEventListener('click', () => {
                panel.classList.toggle('collapsed');
                this.saveCollapsedPanels();
            });
        });
    },

    getCollapsedPanels() {
        try { return JSON.parse(localStorage.getItem(this.COLLAPSED_KEY)) || []; }
        catch { return []; }
    },

    saveCollapsedPanels() {
        const collapsed = [...UI.$$('.panel.collapsed')].map(p => p.id);
        localStorage.setItem(this.COLLAPSED_KEY, JSON.stringify(collapsed));
    },

    init() {
        this.setupCollapsiblePanels();
        this.renderSidebar();
        this.renderUser();
        initEditForm();
        initScrollModal();
        const hash = window.location.hash.slice(1);
        if (hash) {
            this.selectGuild(hash);
        } else {
            window.location.hash = this.PINNED_GUILD;
            this.selectGuild(this.PINNED_GUILD);
        }
        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            if (hash && hash !== this.currentGuildId) this.selectGuild(hash);
        });
    },

    getRecentGuilds() {
        try { return JSON.parse(localStorage.getItem(this.STORAGE_KEY)) || {}; }
        catch { return {}; }
    },

    recordGuildAccess(guildId) {
        const recent = this.getRecentGuilds();
        recent[guildId] = Date.now();
        localStorage.setItem(this.STORAGE_KEY, JSON.stringify(recent));
    },

    sortGuilds(guilds) {
        const recent = this.getRecentGuilds();
        return guilds.slice().sort((a, b) => {
            if (a.id === this.PINNED_GUILD) return -1;
            if (b.id === this.PINNED_GUILD) return 1;
            return (recent[b.id] || 0) - (recent[a.id] || 0);
        });
    },

    renderSidebar(animate = false) {
        const container = UI.$('#guilds-list');
        const userGuilds = this.sortGuilds(State.getUserGuilds());
        if (userGuilds.length === 0) {
            container.innerHTML = '<div class="empty-state">No guilds found</div>';
            return;
        }
        const oldPositions = {};
        if (animate) {
            container.querySelectorAll('.guild-item').forEach(item => {
                oldPositions[item.dataset.guildId] = item.getBoundingClientRect();
            });
        }
        container.innerHTML = userGuilds.map(guild => `
            <div class="guild-item" data-guild-id="${guild.id}" data-tooltip="${UI.escapeHtml(guild.name)}">
                <span class="guild-icon" style="color: ${guild.color || '#c9a227'}">${guild.icon || 'â¬¡'}</span>
                ${guild.unread ? `<span class="guild-badge">${guild.unread}</span>` : ''}
            </div>
        `).join('');
        if (animate && Object.keys(oldPositions).length > 0) {
            const items = container.querySelectorAll('.guild-item');
            items.forEach(item => {
                const oldPos = oldPositions[item.dataset.guildId];
                if (oldPos) {
                    const newPos = item.getBoundingClientRect();
                    const deltaY = oldPos.top - newPos.top;
                    if (deltaY !== 0) {
                        item.style.transition = 'none';
                        item.style.transform = `translateY(${deltaY}px)`;
                    }
                }
            });
            container.offsetHeight;
            items.forEach(item => { item.style.transition = ''; item.style.transform = ''; });
        }
        container.querySelectorAll('.guild-item').forEach(item => {
            item.addEventListener('click', () => {
                window.location.hash = item.dataset.guildId;
                this.selectGuild(item.dataset.guildId);
            });
        });
    },

    renderUser() {
        if (State.user) {
            UI.$('#user-name').textContent = State.user.name || State.user.username;
            UI.$('#user-avatar').src = `https://brothers.skymasons.xyz/avatar/${encodeURIComponent(State.user.username)}/32`;
        }
    },

    async selectGuild(guildId) {
        const guild = State.getGuildById(guildId);
        if (!guild) { console.error('Guild not found:', guildId); return; }
        this.currentGuildId = guildId;
        this.currentTalkRoom = guild.resources?.talkRoom;
        this.folderStack = [];
        UI.$('#guild-edit-form').classList.remove('active');
        currentEditGuild = null;
        currentEditGuildId = null;
        State.currentGuild = guild;
        if (guildId !== this.PINNED_GUILD) {
            this.recordGuildAccess(guildId);
            this.renderSidebar(true);
        }
        UI.$$('.guild-item').forEach(item => item.classList.toggle('active', item.dataset.guildId === guildId));
        UI.$('#guild-icon').textContent = guild.icon || 'â¬¡';
        UI.$('#guild-icon').style.color = guild.color || '#c9a227';
        UI.$('#guild-name').textContent = guild.name;
        UI.$('#guild-name').style.color = guild.color || '#c9a227';
        UI.$('#guild-desc').textContent = guild.description || '';
        UI.$('#guild-desc').style.display = guild.description ? 'block' : 'none';
        const metaItems = [];
        if (guild.category) metaItems.push(`<span class="guild-meta-badge">${UI.escapeHtml(guild.category)}</span>`);
        if (guild.seederUid) metaItems.push(`<span class="guild-meta-item"><span class="guild-meta-label">Seeded by</span> <a href="https://brothers.skymasons.xyz/u/${encodeURIComponent(guild.seederUid)}" class="guild-overview-link" target="_blank">@${UI.escapeHtml(guild.seederUid)}</a></span>`);
        const memberCount = guild.memberCount || (guild.members?.length || 0);
        if (memberCount) metaItems.push(`<span class="guild-meta-item"><span class="guild-meta-value">${memberCount}</span> <span class="guild-meta-label">${memberCount === 1 ? 'member' : 'members'}</span></span>`);
        if (guild.admission) metaItems.push(`<span class="guild-meta-item"><span class="guild-meta-label">Admission:</span> <span class="guild-meta-value">${guild.admission === 'open' ? 'Open' : 'Application'}</span></span>`);
        UI.$('#guild-meta').innerHTML = metaItems.join('');
        // Show edit button for seeders/admins
        const editBtn = UI.$('#guild-edit-btn');
        const currentUser = State.user?.username?.toLowerCase();
        const isSeeder = guild.seederUid && guild.seederUid.toLowerCase() === currentUser;
        const isAdmin = State.user?.isAdmin || State.user?.groups?.includes('admins');
        if (isSeeder || isAdmin) {
            editBtn.classList.add('visible');
            editBtn.onclick = () => toggleEditForm(guild, guildId);
        } else {
            editBtn.classList.remove('visible');
            UI.$('#guild-edit-form').classList.remove('active');
        }
        const talkRoom = guild.resources?.talkRoom;
        const calendarUri = guild.resources?.calendarUri;
        const folderName = guild.resources?.folderName;
        const deckBoardId = guild.resources?.deckBoardId;
        UI.$('#chat-link').href = talkRoom ? `https://palaver.skymasons.xyz/call/${talkRoom}` : '#';
        UI.$('#calendar-link').href = calendarUri ? `https://astrologue.skymasons.xyz/apps/calendar` : '#';
        UI.$('#deck-link').href = deckBoardId ? `https://archives.skymasons.xyz/apps/deck/#/board/${deckBoardId}` : 'https://archives.skymasons.xyz/apps/deck';
        UI.$('#files-link').href = folderName ? `https://archives.skymasons.xyz/apps/files/files?dir=/${encodeURIComponent(folderName)}` : '#';
        this.loadChat(guild);
        this.loadCalendar(guild);
        this.loadDeck(guild);
        this.loadForms(guild);
        this.loadFiles(guild);
        this.loadMembers(guild);
    },

    async loadChat(guild) {
        const container = UI.$('#chat-content');
        const talkRoom = guild.resources?.talkRoom;
        if (!talkRoom) { UI.setEmpty(container, 'No chat room configured'); return; }
        UI.setLoading(container);
        try {
            const messages = await API.getChatMessages(talkRoom, 20);
            this.renderChat(container, messages, talkRoom);
        } catch (e) {
            console.error('Failed to load chat:', e);
            UI.setEmpty(container, 'Could not load messages');
        }
    },

    renderChat(container, messages, talkRoom) {
        const hasMessages = messages && messages.length > 0;
        container.innerHTML = `
            <div class="chat-wrapper">
                <div class="chat-messages" id="chat-messages">
                    ${hasMessages ? messages.map(msg => this.renderMessage(msg)).join('') : '<div class="empty-state">No recent messages</div>'}
                </div>
                <form class="chat-input-form" id="chat-form">
                    <input type="text" class="chat-input" id="chat-input" placeholder="Type a message..." autocomplete="off">
                    <button type="submit" class="chat-send" id="chat-send">Send</button>
                </form>
            </div>
        `;
        const messagesDiv = UI.$('#chat-messages');
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        UI.$('#chat-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            await this.sendMessage(talkRoom);
        });
        this.bindReactions();
    },

    bindReactions() {
        UI.$$('.add-reaction-btn').forEach(btn => {
            btn.onclick = e => { e.stopPropagation(); EmojiPicker.open(btn.dataset.msgId, btn); };
        });
        UI.$$('.reaction-pill').forEach(pill => {
            pill.onclick = async e => {
                e.stopPropagation();
                const msgId = pill.dataset.msgId;
                const emoji = pill.dataset.emoji;
                const isOwn = pill.classList.contains('own');
                try {
                    if (isOwn) await API.removeReaction(App.currentTalkRoom, msgId, emoji);
                    else await API.addReaction(App.currentTalkRoom, msgId, emoji);
                    App.loadChat(State.currentGuild);
                } catch (e) { console.error('Reaction toggle failed:', e); }
            };
        });
    },

    renderMessage(msg) {
        if (msg.messageType === 'system') return '';
        if (msg.message && msg.message.startsWith('{"message":')) return '';
        const isHerald = msg.actorId?.toLowerCase() === 'herald' || msg.actorDisplayName?.toLowerCase() === 'herald';
        if (isHerald) {
            const text = msg.message || '';
            const appMatch = text.match(/\*\*(.+?)\*\* has applied to \*\*(.+?)\*\*/i) ||
                             text.match(/New application from \*\*(.+?)\*\* for \*\*(.+?)\*\*/i) ||
                             text.match(/(.+?) has applied to join (.+)/i);
            if (appMatch) {
                const applicant = appMatch[1].replace(/\*\*/g, '');
                const guildName = appMatch[2].replace(/\*\*/g, '');
                const guildId = guildName.toLowerCase().replace(/\s+/g, '-');
                return `
                    <div class="herald-announcement">
                        <div class="herald-label">ğŸ“¯ New Application</div>
                        <div class="herald-text"><strong>${UI.escapeHtml(applicant)}</strong> seeks to join</div>
                        <a href="https://sanctum.skymasons.xyz/guild.html#${encodeURIComponent(guildId)}" target="_blank" class="herald-action">Review Application</a>
                        <div class="herald-time">${UI.formatTime(msg.timestamp)}</div>
                    </div>
                `;
            }
            return `
                <div class="herald-announcement">
                    <div class="herald-label">ğŸ“¯ Herald</div>
                    <div class="herald-text">${UI.escapeHtml(text)}</div>
                    <div class="herald-time">${UI.formatTime(msg.timestamp)}</div>
                </div>
            `;
        }
        const avatarUrl = `https://brothers.skymasons.xyz/avatar/${encodeURIComponent(msg.actorId)}/32`;
        const reactions = msg.reactions || {};
        const reactionsSelf = msg.reactionsSelf || [];
        const currentUser = State.user?.username;
        let reactionsHtml = '';
        const entries = Object.entries(reactions);
        if (entries.length > 0 || true) {
            reactionsHtml = `<div class="msg-reactions">`;
            entries.forEach(([emoji, count]) => {
                const isOwn = reactionsSelf.includes(emoji);
                reactionsHtml += `<button class="reaction-pill ${isOwn ? 'own' : ''}" data-msg-id="${msg.id}" data-emoji="${emoji}"><span class="r-emoji">${emoji}</span><span class="r-count">${count}</span></button>`;
            });
            reactionsHtml += `<button class="add-reaction-btn" data-msg-id="${msg.id}" title="Add reaction">+</button></div>`;
        }
        return `
            <div class="chat-message" data-msg-id="${msg.id}">
                <img class="msg-avatar" src="${avatarUrl}" alt="">
                <div class="msg-content">
                    <div class="msg-header">
                        <span class="author">${UI.escapeHtml(msg.actorDisplayName || msg.actorId)}</span>
                        <span class="time">${UI.formatTime(msg.timestamp)}</span>
                    </div>
                    <div class="text">${UI.escapeHtml(msg.message)}</div>
                    ${reactionsHtml}
                </div>
            </div>
        `;
    },

    async sendMessage(talkRoom) {
        const input = UI.$('#chat-input');
        const btn = UI.$('#chat-send');
        const message = input.value.trim();
        if (!message) return;
        btn.disabled = true;
        input.disabled = true;
        try {
            const result = await API.sendChatMessage(talkRoom, message);
            input.value = '';
            const messagesDiv = UI.$('#chat-messages');
            const emptyState = messagesDiv.querySelector('.empty-state');
            if (emptyState) emptyState.remove();
            messagesDiv.insertAdjacentHTML('beforeend', this.renderMessage(result));
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
            this.bindReactions();
        } catch (e) {
            console.error('Failed to send message:', e);
            alert('Failed to send message');
        } finally {
            btn.disabled = false;
            input.disabled = false;
            input.focus();
        }
    },

    async loadCalendar(guild) {
        const container = UI.$('#calendar-content');
        const calendarUri = guild.resources?.calendarUri;
        if (!calendarUri) { UI.setEmpty(container, 'No calendar configured'); return; }
        UI.setLoading(container);
        try {
            const events = await API.getCalendarEvents(calendarUri);
            if (!events || events.length === 0) { UI.setEmpty(container, 'No upcoming events'); return; }
            container.innerHTML = `<div class="event-list">
                ${events.slice(0, 5).map(event => {
                    const date = UI.formatDate(event.start);
                    return `<div class="event-item">
                        <div class="event-date"><div class="day">${date.day}</div><div class="month">${date.month}</div></div>
                        <div class="event-details"><div class="title">${UI.escapeHtml(event.title)}</div><div class="time">${date.time}</div></div>
                    </div>`;
                }).join('')}
            </div>`;
        } catch (e) {
            console.error('Failed to load calendar:', e);
            UI.setEmpty(container, 'Could not load events');
        }
    },

    async loadDeck(guild) {
        const container = UI.$('#deck-content');
        const deckBoardId = guild.resources?.deckBoardId;
        if (!deckBoardId) {
            container.innerHTML = `
                <div class="deck-board">
                    <a href="https://archives.skymasons.xyz/apps/deck" target="_blank" class="form-item">
                        <span class="form-icon">âš”</span>
                        <span class="form-info">
                            <span class="form-title">Quest Board</span>
                            <span class="form-meta">Missions and endeavours</span>
                        </span>
                        <span class="form-arrow">â†’</span>
                    </a>
                </div>
            `;
            return;
        }
        UI.setLoading(container);
        try {
            const data = await API.getDeckCards(deckBoardId);
            const cards = data.cards || [];
            if (cards.length === 0) {
                container.innerHTML = `
                    <div class="deck-board">
                        <div class="empty-state">No quests yet</div>
                        <a href="https://archives.skymasons.xyz/apps/deck/#/board/${deckBoardId}" target="_blank" class="form-item" style="margin-top: 0.5rem;">
                            <span class="form-icon">+</span>
                            <span class="form-info"><span class="form-title">Begin a quest</span></span>
                            <span class="form-arrow">â†’</span>
                        </a>
                    </div>
                `;
                return;
            }
            container.innerHTML = `
                <div class="deck-board">
                    ${cards.slice(0, 8).map(card => `
                        <div class="deck-card">
                            <div class="deck-card-labels">
                                ${(card.labels || []).map(l => `<span class="deck-label" style="background: ${l.color}"></span>`).join('')}
                            </div>
                            <span class="deck-card-title">${UI.escapeHtml(card.title)}</span>
                            ${card.duedate ? `<span class="deck-card-due ${new Date(card.duedate) < new Date() ? 'overdue' : ''}">${UI.formatDueDate(card.duedate)}</span>` : ''}
                        </div>
                    `).join('')}
                    ${cards.length > 8 ? `<a href="https://archives.skymasons.xyz/apps/deck/#/board/${deckBoardId}" target="_blank" class="form-item"><span class="form-info"><span class="form-meta">+${cards.length - 8} more quests</span></span><span class="form-arrow">â†’</span></a>` : ''}
                </div>
            `;
        } catch (e) {
            console.error('Failed to load deck:', e);
            container.innerHTML = `
                <div class="deck-board">
                    <a href="https://archives.skymasons.xyz/apps/deck/#/board/${deckBoardId}" target="_blank" class="form-item">
                        <span class="form-icon">âš”</span>
                        <span class="form-info"><span class="form-title">View Board in Deck</span></span>
                        <span class="form-arrow">â†’</span>
                    </a>
                </div>
            `;
        }
    },

    async loadForms(guild) {
        const container = UI.$("#forms-content");
        const guildId = guild.id;
        const scrolls = ScrollsManager.getScrolls(guildId);
        
        container.innerHTML = `
            <div class="scrolls-container">
                <div class="scrolls-toolbar">
                    <span class="scrolls-count">${scrolls.length} scroll${scrolls.length !== 1 ? "s" : ""}</span>
                </div>
                ${scrolls.length === 0 ? 
                    "<div class=\"scrolls-empty\">No scrolls yet. Click + to create one.</div>" : 
                    `<div class=\"scrolls-list\">
                        ${scrolls.map(scroll => `
                            <div class=\"scroll-item\" data-id=\"${scroll.id}\">
                                <span class=\"scroll-type-icon\">${ScrollsManager.getTypeIcon(scroll.type)}</span>
                                <div class=\"scroll-info\">
                                    <span class=\"scroll-title\">${UI.escapeHtml(scroll.title)}</span>
                                    <span class=\"scroll-meta\">${ScrollsManager.getTypeName(scroll.type)} â€¢ ${UI.formatDate(scroll.created)}</span>
                                </div>
                                <div class=\"scroll-actions\">
                                    <button class=\"scroll-action\" data-action=\"view\" title=\"View\">ğŸ‘</button>
                                    <button class=\"scroll-action\" data-action=\"edit\" title=\"Edit\">âœ</button>
                                    <button class=\"scroll-action danger\" data-action=\"delete\" title=\"Delete\">âœ•</button>
                                </div>
                            </div>
                        `).join("")}
                    </div>`
                }
            </div>
        `;
        this.setupScrollActions(guildId);
    },

    setupScrollActions(guildId) {
        UI.$$(".scroll-item .scroll-action").forEach(btn => {
            btn.addEventListener("click", (e) => {
                e.stopPropagation();
                const item = btn.closest(".scroll-item");
                const scrollId = item.dataset.id;
                const action = btn.dataset.action;
                if (action === "view") ScrollsManager.viewScroll(guildId, scrollId);
                else if (action === "edit") ScrollsManager.editScroll(guildId, scrollId);
                else if (action === "delete") ScrollsManager.deleteScroll(guildId, scrollId);
            });
        });
        UI.$$(".scroll-item").forEach(item => {
            item.addEventListener("click", (e) => {
                if (e.target.closest(".scroll-actions")) return;
                ScrollsManager.viewScroll(guildId, item.dataset.id);
            });
        });
    },
    async loadFiles(guild, targetFolderId = null, targetFolderName = null) {
        const container = UI.$('#files-content');
        const rootFolderId = guild.resources?.folderId;
        const rootFolderName = guild.resources?.folderName;
        if (!rootFolderId) { UI.setEmpty(container, 'No folder configured'); return; }
        const folderId = targetFolderId || rootFolderId;
        const folderName = targetFolderName || rootFolderName;
        UI.setLoading(container);
        try {
            const data = await API.getFiles(folderId);
            const files = data.files || [];
            files.sort((a, b) => {
                if (a.type === 'folder' && b.type !== 'folder') return -1;
                if (a.type !== 'folder' && b.type === 'folder') return 1;
                return a.name.localeCompare(b.name);
            });
            container.innerHTML = `
                <div class="archive-container">
                    ${this.renderBreadcrumbs(rootFolderName)}
                    <div class="archive-toolbar">
                        <div class="upload-zone" id="upload-zone">
                            <input type="file" id="file-input" multiple>
                            <div class="upload-zone-text"><strong>Click to upload</strong> or drag files here</div>
                            <div class="upload-progress" id="upload-progress">
                                <div class="upload-progress-bar"><div class="upload-progress-fill" id="upload-fill"></div></div>
                                <div class="upload-progress-text" id="upload-text">Uploading...</div>
                            </div>
                        </div>
                        <button class="new-folder-btn" id="new-folder-btn" title="New Folder">+ Folder</button>
                    </div>
                    ${files.length === 0 ? '<div class="files-empty">No files yet</div>' : `
                    <div class="file-list">
                        ${files.map(file => `
                            <div class="file-item ${file.type === 'folder' ? 'is-folder' : ''}" data-id="${file.id}" data-name="${UI.escapeHtml(file.name)}" data-type="${file.type || 'file'}">
                                <span class="file-icon">${this.getFileIcon(file)}</span>
                                <div class="file-info">
                                    <span class="file-name">${UI.escapeHtml(file.name)}</span>
                                    <span class="file-meta">${file.type === 'folder' ? 'Folder' : (file.size ? UI.formatSize(file.size) : '')}</span>
                                </div>
                                <div class="file-actions">
                                    ${file.type === 'folder' ? '' : `
                                    <button class="file-action" data-action="download" title="Download">â†“</button>
                                    <button class="file-action" data-action="share" title="Share link">âŠ•</button>
                                    `}
                                    <button class="file-action danger" data-action="delete" title="Delete">âœ•</button>
                                </div>
                            </div>
                        `).join('')}
                    </div>`}
                </div>
            `;
            this.setupFileActions(folderId, folderName);
        } catch (e) {
            console.error('Failed to load files:', e);
            UI.setEmpty(container, 'Could not load files');
        }
    },

    renderBreadcrumbs(rootFolderName) {
        const isAtRoot = this.folderStack.length === 0;
        let html = '<nav class="breadcrumb"><span class="breadcrumb-icon">ğŸ“‚</span>';
        html += `<span class="breadcrumb-item root ${isAtRoot ? 'current' : ''}" data-index="-1">${UI.escapeHtml(rootFolderName)}</span>`;
        this.folderStack.forEach((folder, index) => {
            const isCurrent = index === this.folderStack.length - 1;
            html += '<span class="breadcrumb-sep">â€º</span>';
            html += `<span class="breadcrumb-item ${isCurrent ? 'current' : ''}" data-index="${index}">${UI.escapeHtml(folder.name)}</span>`;
        });
        return html + '</nav>';
    },

    navigateToFolder(folderId, folderName) {
        this.folderStack.push({ id: folderId, name: folderName });
        this.loadFiles(State.currentGuild, folderId, folderName);
    },

    navigateToBreadcrumb(index) {
        if (index === -1) {
            this.folderStack = [];
            this.loadFiles(State.currentGuild);
        } else if (index < this.folderStack.length - 1) {
            this.folderStack = this.folderStack.slice(0, index + 1);
            const folder = this.folderStack[index];
            this.loadFiles(State.currentGuild, folder.id, folder.name);
        }
    },

    setupFileActions(folderId, folderName) {
        const uploadZone = UI.$('#upload-zone');
        const fileInput = UI.$('#file-input');
        uploadZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) this.uploadFiles(e.target.files, folderId, folderName);
        });
        uploadZone.addEventListener('dragover', (e) => { e.preventDefault(); uploadZone.classList.add('drag-over'); });
        uploadZone.addEventListener('dragleave', () => uploadZone.classList.remove('drag-over'));
        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            if (e.dataTransfer.files.length > 0) this.uploadFiles(e.dataTransfer.files, folderId, folderName);
        });
        UI.$$('.file-item.is-folder').forEach(item => {
            item.addEventListener('click', (e) => {
                if (e.target.closest('.file-actions')) return;
                this.navigateToFolder(item.dataset.id, item.dataset.name);
            });
        });
        UI.$$('.breadcrumb-item').forEach(crumb => {
            if (crumb.classList.contains('current')) return;
            crumb.addEventListener('click', () => this.navigateToBreadcrumb(parseInt(crumb.dataset.index, 10)));
        });
        UI.$$('.file-item .file-action').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.stopPropagation();
                const item = btn.closest('.file-item');
                const action = btn.dataset.action;
                if (action === 'download') this.downloadFile(item.dataset.id, item.dataset.name, folderName);
                else if (action === 'share') this.shareFile(item.dataset.id, item.dataset.name);
                else if (action === 'delete') this.deleteFile(item.dataset.id, item.dataset.name, folderId, item.dataset.type);
            });
        });
        const newFolderBtn = UI.$('#new-folder-btn');
        if (newFolderBtn) newFolderBtn.addEventListener('click', () => this.createFolder(folderId));
    },

    async createFolder(parentFolderId) {
        const name = prompt('Enter folder name:');
        if (!name || !name.trim()) return;
        try {
            await API.createFolder(parentFolderId, name.trim());
            this.refreshCurrentFolder();
        } catch (e) {
            console.error('Failed to create folder:', e);
            alert('Could not create folder');
        }
    },

    refreshCurrentFolder() {
        if (this.folderStack.length > 0) {
            const current = this.folderStack[this.folderStack.length - 1];
            this.loadFiles(State.currentGuild, current.id, current.name);
        } else {
            this.loadFiles(State.currentGuild);
        }
    },

    async uploadFiles(files, folderId, folderName) {
        const progress = UI.$('#upload-progress');
        const fill = UI.$('#upload-fill');
        const text = UI.$('#upload-text');
        progress.classList.add('active');
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            text.textContent = `Uploading ${file.name}... (${i + 1}/${files.length})`;
            fill.style.width = `${((i + 0.5) / files.length) * 100}%`;
            try { await API.uploadFile(folderId, folderName, file); }
            catch (e) { console.error('Upload failed:', e); alert(`Failed to upload ${file.name}`); }
        }
        fill.style.width = '100%';
        text.textContent = 'Upload complete!';
        setTimeout(() => { progress.classList.remove('active'); fill.style.width = '0%'; this.refreshCurrentFolder(); }, 1000);
    },

    getCurrentFolderPath() {
        const rootName = State.currentGuild?.resources?.folderName || '';
        if (this.folderStack.length === 0) return rootName;
        return rootName + '/' + this.folderStack.map(f => f.name).join('/');
    },

    downloadFile(fileId, fileName, folderName) {
        const folderPath = this.getCurrentFolderPath();
        const encodedPath = folderPath.split('/').map(encodeURIComponent).join('/');
        window.open(`https://archives.skymasons.xyz/remote.php/dav/files/${State.user.username}/${encodedPath}/${encodeURIComponent(fileName)}`, '_blank');
    },

    async shareFile(fileId, fileName) {
        try {
            const result = await API.createShareLink(fileId);
            if (result.url) { await navigator.clipboard.writeText(result.url); alert('Share link copied to clipboard!'); }
        } catch (e) { console.error('Share failed:', e); alert('Could not create share link'); }
    },

    async deleteFile(fileId, fileName, folderId, fileType) {
        const itemType = fileType === 'folder' ? 'folder' : 'file';
        if (!confirm(`Delete ${itemType} "${fileName}"?`)) return;
        try { await API.deleteFile(fileId); this.refreshCurrentFolder(); }
        catch (e) { console.error('Delete failed:', e); alert(`Could not delete ${itemType}`); }
    },

    getFileIcon(file) {
        if (file.type === 'folder') return 'ğŸ“';
        const ext = (file.extension || '').toLowerCase();
        const icons = { pdf:'ğŸ“„', doc:'ğŸ“', docx:'ğŸ“', txt:'ğŸ“', xls:'ğŸ“Š', xlsx:'ğŸ“Š', csv:'ğŸ“Š', jpg:'ğŸ–¼', jpeg:'ğŸ–¼', png:'ğŸ–¼', gif:'ğŸ–¼', webp:'ğŸ–¼', mp3:'ğŸµ', wav:'ğŸµ', ogg:'ğŸµ', mp4:'ğŸ¬', mov:'ğŸ¬', avi:'ğŸ¬', zip:'ğŸ“¦', rar:'ğŸ“¦', tar:'ğŸ“¦', gz:'ğŸ“¦' };
        return icons[ext] || 'ğŸ“„';
    },

    loadMembers(guild) {
        const container = UI.$('#members-content');
        const members = guild.members || [];
        UI.$('#member-count').textContent = members.length;
        if (members.length === 0) { UI.setEmpty(container, 'No members'); return; }
        container.innerHTML = `<div class="members-list">
            ${members.map(member => `
                <a href="https://brothers.skymasons.xyz/u/${encodeURIComponent(member)}" class="member-item" target="_blank">
                    <img class="member-avatar" src="https://brothers.skymasons.xyz/avatar/${encodeURIComponent(member)}/32" alt="">
                    <span class="member-name">${UI.escapeHtml(member)}</span>
                    <span class="member-link-icon">â†’</span>
                </a>
            `).join('')}
        </div>`;
    }
};
    </script>
    <!-- View Scroll Modal -->
    <div class="modal-overlay" id="scroll-view-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="view-scroll-title">Scroll Title</h2>
                <button class="modal-close" id="scroll-view-close">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="scroll-view-meta">
                    <span id="view-scroll-type"></span>
                    <span class="meta-sep">â€¢</span>
                    <span id="view-scroll-date"></span>
                </div>
                <div class="scroll-view-content" id="view-scroll-content"></div>
            </div>
        </div>
    </div>

    <!-- Create Scroll Modal -->
    <div class="modal-overlay" id="scroll-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>âœ Create Scroll</h2>
                <button class="modal-close" id="scroll-modal-close">Ã—</button>
            </div>
            <form id="scroll-form" class="modal-form">
                <div class="form-group">
                    <label for="scroll-title">Title</label>
                    <input type="text" id="scroll-title" placeholder="Enter scroll title..." required>
                </div>
                <div class="form-group">
                    <label for="scroll-type">Type</label>
                    <select id="scroll-type">
                        <option value="petition">ğŸ“œ Petition</option>
                        <option value="poll">ğŸ“Š Poll</option>
                        <option value="inquiry">â“ Inquiry</option>
                        <option value="announcement">ğŸ“¢ Announcement</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="scroll-content">Content</label>
                    <textarea id="scroll-content" rows="5" placeholder="Describe your scroll..."></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="scroll-cancel">Cancel</button>
                    <button type="submit" class="btn-primary">Create Scroll</button>
                </div>
            </form>
        </div>
    </div>
</body>
</html>
